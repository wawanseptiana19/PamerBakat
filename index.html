<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manager Tautan — Index</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;background:#f8fafc} .container{max-width:1100px;margin:28px auto}</style>
</head>
<body>
  <div class="container px-4">
    <div class="bg-white p-6 rounded-lg shadow">
      <h1 class="text-2xl font-semibold mb-4">Daftar Tautan</h1>
      <p class="text-sm text-gray-600 mb-4">Gunakan tombol <strong>Lihat</strong> untuk membuka pratinjau, dan <strong>Proses Dekripsi</strong> untuk langsung membuka halaman dekripsi (kedua tombol membuka tab baru menggunakan <code>preview.html</code>).</p>

      <div id="linksWrap" class="overflow-auto">
        <!-- Tabel akan di-populate oleh JS -->
        <table class="w-full text-sm table-auto" id="linksTable">
          <thead>
            <tr class="text-left"><th class="p-2">#</th><th class="p-2">Nama</th><th class="p-2">URL</th><th class="p-2">Shift</th><th class="p-2">Aksi</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="mt-4">
        <button id="addSample" class="px-3 py-2 rounded bg-blue-600 text-white">Tambah contoh data</button>
        <button id="reload" class="px-3 py-2 rounded border ml-2">Reload</button>
      </div>
    </div>
  </div>

<script>
// =================================================================================
// index.html (minimal) — fokus: membuka preview.html di tab baru untuk tombol Lihat & Proses
// Pastikan file preview.html sudah ada di folder yang sama.
// =================================================================================

(function(){
  const tbody = document.querySelector('#linksTable tbody');
  let data = [];

  // contoh data (Anda bisa menggantinya dengan data dari Supabase atau sumber lain)
  function sampleData(){
    return [
      {name:'Gambar 1', url:'https://raw.githubusercontent.com/your/repo/main/encrypted1.txt', shift_code:3, person_name:'risky'},
      {name:'Video 2', url:'https://raw.githubusercontent.com/your/repo/main/encrypted2.txt', shift_code:5, person_name:'anon'},
      {name:'Teks 3', url:'https://raw.githubusercontent.com/your/repo/main/encrypted3.txt', shift_code:2, person_name:'user'}
    ];
  }

  function shorten(u){ try{ const url = new URL(u); return url.hostname + url.pathname.slice(0,40) + (url.pathname.length>40?'...':''); }catch(e){ return u.slice(0,80) + (u.length>80?'...':''); }}

  // buka preview di tab baru dengan noopener (tidak menyimpan referer/perilaku di parent)
  function openPreviewInNewTab(item, extraParams){
    const params = new URLSearchParams({
      url: item.url || '',
      shift: item.shift_code || '',
      person: item.person_name || '',
      name: item.name || ''
    });
    if (extraParams && typeof extraParams === 'object'){
      Object.entries(extraParams).forEach(([k,v]) => params.set(k, v));
    }
    const previewPath = 'preview.html'; // pastikan file ini tersedia di folder sama
    window.open(previewPath + '?' + params.toString(), '_blank', 'noopener');
  }

  function render(){
    tbody.innerHTML = '';
    data.forEach((it, idx) => {
      const tr = document.createElement('tr');
      tr.className = idx % 2 === 0 ? 'bg-white' : 'bg-gray-50';
      tr.innerHTML = `
        <td class="p-2 align-top">${idx+1}</td>
        <td class="p-2 align-top">${escapeHtml(it.name || '')}</td>
        <td class="p-2 align-top"><div class="text-xs text-gray-600">${escapeHtml(shorten(it.url || ''))}</div></td>
        <td class="p-2 align-top">${escapeHtml(String(it.shift_code || ''))}</td>
        <td class="p-2 align-top"></td>
      `;
      const actionsTd = tr.querySelector('td:last-child');

      const viewBtn = document.createElement('button');
      viewBtn.textContent = 'Lihat';
      viewBtn.className = 'px-3 py-1 rounded border mr-2';
      viewBtn.addEventListener('click', () => openPreviewInNewTab(it));

      const processBtn = document.createElement('button');
      processBtn.textContent = 'Proses Dekripsi';
      processBtn.className = 'px-3 py-1 rounded bg-green-600 text-white';
      // kita tambahkan param action=process agar preview tahu ini diminta "proses"
      processBtn.addEventListener('click', () => openPreviewInNewTab(it, {action:'process'}));

      actionsTd.appendChild(viewBtn);
      actionsTd.appendChild(processBtn);

      tbody.appendChild(tr);
    });
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\' : '&#39;'}[m]; }); }

  // tombol bantuan
  document.getElementById('addSample').addEventListener('click', () => { data = data.concat(sampleData()); render(); });
  document.getElementById('reload').addEventListener('click', () => render());

  // inisialisasi sederhana — bisa diganti dengan pemanggilan Supabase untuk ambil data nyata
  data = sampleData(); render();

})();
</script>
</body>
</html>
