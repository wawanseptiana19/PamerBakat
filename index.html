<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Daftar Tautan Supabase — Dekripsi & Preview Media</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <style>
        body { background-color: #f8fafc; font-family: 'Inter', system-ui, sans-serif; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        table { border-collapse: separate; border-spacing: 0; }
        th { background: #f1f5f9; font-weight: 600; color: #1e293b; }
        tr:nth-child(even) { background-color: #f8fafc; }
        tr:hover { background-color: #e0f2fe; transition: background 0.2s; }
        .name-tag {
            padding: 0.6rem 1.4rem;
            background: #dbeafe;
            color: #1e40af;
            borderRadius: 9999px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .name-tag:hover { background: #bfdbfe; transform: translateY(-2px); }
        .name-tag.active { background: #1d4ed8; color: white; }
        .btn-primary {
            background: linear-gradient(to right, #3b82f6, #1d4ed8);
            color: white;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(59,130,246,0.35); }
        .qr-cell canvas { border: 4px solid #e0e7ff; border-radius: 0.75rem; }
        #loginOverlay { backdrop-filter: blur(10px); }
        @media (max-width: 640px) {
            .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            #nameTags { justify-content: center; gap: 0.75rem; }
            .name-tag { font-size: 0.9rem; padding: 0.55rem 1.1rem; }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body class="min-h-screen bg-slate-50">

  <div id="loginOverlay" class="fixed inset-0 bg-slate-900/70 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 text-center">
      <h2 class="text-2xl font-bold text-slate-800 mb-2">Masuk ke halaman</h2>
      <p class="text-slate-600 mb-6">Unggah file .bat untuk akses</p>
      <input id="loginFileInput" type="file" accept=".bat,text/plain" class="block w-full text-sm text-slate-500 file:mr-4 file:py-3 file:px-8 file:rounded-xl file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700">
      <div id="loginMsg" class="mt-4 min-h-6 text-sm font-medium"></div>
      <button id="logoutBtn" class="mt-5 text-sm text-slate-500 hover:text-slate-700" style="display:none;">Keluar</button>
    </div>
  </div>

  <div id="pageContent" class="container max-w-7xl mx-auto px-4 py-8 transition-all duration-300">
    <div class="card p-8 mb-8">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
        <h1 class="text-4xl font-bold text-slate-800">Daftar Tautan</h1>
        <div class="flex flex-wrap items-center gap-4">
          <button id="downloadAllQrBtn" class="btn-primary flex items-center gap-2 text-lg">
            <i class="fa-solid fa-file-zipper"></i> <span class="hidden sm:inline">Unduh Semua QR</span>
          </button>
          <a href="https://pamer-bakat.vercel.app/tambah_konten.html" target="_blank" class="p-4 bg-green-600 text-white rounded-xl hover:bg-green-700 transition text-2xl">
            <i class="fa-solid fa-plus"></i>
          </a>
          <div class="relative">
            <input type="text" id="searchInput" placeholder="Cari nama / judul..." class="pl-12 pr-14 py-4 border border-slate-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-200 w-full md:w-96 text-lg">
            <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl"></i>
            <button id="clearSearchBtn" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden text-xl">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="mt-12">
        <h2 class="text-2xl font-semibold text-slate-700 mb-6">Filter cepat berdasarkan nama:</h2>
        <div id="nameTags" class="flex flex-wrap gap-4"></div>
      </div>
    </div>

    <div class="card overflow-hidden">
      <div class="table-container overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="text-left text-sm font-semibold text-slate-600 uppercase tracking-wider">
              <th class="px-6 py-5">QR</th>
              <th class="px-6 py-5">Nama</th>
              <th class="px-6 py-5">Judul</th>
              <th class="px-6 py-5">Kategori</th>
              <th class="px-6 py-5">URL</th>
              <th class="px-6 py-5">Shift</th>
              <th class="px-6 py-5">Dibuat</th>
              <th class="px-6 py-5 text-center">Aksi</th>
              <th class="px-6 py-5 text-center">Hapus</th>
            </tr>
          </thead>
          <tbody id="links-table-body" class="divide-y divide-slate-200 text-slate-700 text-base">
          </tbody>
        </table>
      </div>

      <div id="loadingIndicator" class="text-center py-32 text-slate-500">
        <i class="fa-solid fa-spinner fa-spin text-6xl mb-6"></i>
        <p class="text-2xl font-medium">Memuat data...</p>
      </div>
    </div>

    <div id="statusPopup" class="fixed top-6 left-1/2 -translate-x-1/2 px-8 py-4 rounded-full text-white font-semibold shadow-2xl z-50 opacity-0 transition-opacity duration-300"></div>
  </div>

  <div id="qrModal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl p-10 max-w-md w-full text-center shadow-2xl">
      <button id="closeModal" class="absolute top-6 right-8 text-3xl text-slate-400 hover:text-slate-600">×</button>
      <div id="enlargedQrContainer" class="mx-auto"></div>
      <button id="downloadSingleQrBtn" class="mt-8 btn-primary w-full py-4 text-lg">
        <i class="fa-solid fa-download mr-3"></i> Unduh QR Code
      </button>
    </div>
  </div>

  <div id="descriptionModal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl max-w-4xl w-full max-h-[95vh] overflow-y-auto p-10 relative">
      <button id="closeDescriptionModal" class="absolute top-6 right-8 text-4xl text-slate-400 hover:text-slate-600">×</button>
      <h2 class="text-4xl font-bold text-center mb-10 text-slate-800">Preview Konten</h2>
      <div id="descriptionLoading" class="text-center py-16 hidden">
        <i class="fa-solid fa-spinner fa-spin text-7xl text-blue-600 mb-6"></i>
        <p class="text-xl">Memuat dan mendekripsi...</p>
      </div>
      <div id="descriptionContent" class="flex flex-col items-center"></div>
      <p id="descriptionMessage" class="text-red-600 text-center mt-6 text-lg hidden"></p>
      <button id="downloadBtn" class="hidden mt-10 btn-primary py-5 px-16 text-xl font-bold">
        Unduh Konten
      </button>
    </div>
  </div>

  <script>
    (function(){
      const SECRET_TEXT = 'YQDYIpjYnF7PZtDYs6e8yZJmGqTuB4rgZQSaenc618nmy4x095';
      const overlay = document.getElementById('loginOverlay');
      const fileInput = document.getElementById('loginFileInput');
      const msg = document.getElementById('loginMsg');
      const logoutBtn = document.getElementById('logoutBtn');
      const pageContent = document.getElementById('pageContent');
      function lockPage() {
        overlay.style.display = 'flex';
        document.documentElement.classList.add('lock-scroll');
        document.body.classList.add('lock-scroll');
        pageContent.classList.add('blurred');
      }
      function unlockPage() {
        overlay.style.display = 'none';
        document.documentElement.classList.remove('lock-scroll');
        document.body.classList.remove('lock-scroll');
        pageContent.classList.remove('blurred');
        logoutBtn.style.display = 'block';
      }
      function resetAccess() {
        fileInput.value = '';
        msg.textContent = '';
        logoutBtn.style.display = 'none';
        lockPage();
      }
      lockPage();
      fileInput.addEventListener('change', (ev) => {
        msg.textContent = '';
        const f = ev.target.files[0];
        if (!f) return msg.textContent = 'Tidak ada file dipilih';
        if (!f.name.toLowerCase().endsWith('.bat')) {
          msg.textContent = 'File harus .bat';
          msg.style.color = '#b91c1c';
          return;
        }
        const reader = new FileReader();
        reader.onload = e => {
          let text = e.target.result;
          if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
          if (text.trim() === SECRET_TEXT) {
            unlockPage();
            msg.textContent = 'Akses diberikan ✓';
            msg.style.color = '#059669';
          } else {
            msg.textContent = 'File salah Isi tidak cocok';
            msg.style.color = '#b91c1c';
          }
        };
        reader.readAsText(f);
      });
      logoutBtn.addEventListener('click', () => confirm('Keluar dan reset akses?') && resetAccess());
    })();
  </script>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.2/+esm';
    const supabaseUrl = 'https://qzdvdfebkzlwkhvxwsju.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6ZHZkZmVia3psd2todnh3c2p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzcyMTA4OTksImV4cCI6MjA1Mjc4Njg5OX0.Z9XKmX49vu0kZwn6YMom8QeLNNdKQMXCIkxcIoHKQFs';
    const supabase = createClient(supabaseUrl, supabaseKey);
    const linksTableBody = document.getElementById('links-table-body');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const statusPopup = document.getElementById('statusPopup');
    const searchInput = document.getElementById('searchInput');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const qrModal = document.getElementById('qrModal');
    const closeModalButton = document.getElementById('closeModal');
    const descriptionModal = document.getElementById('descriptionModal');
    const closeDescriptionModalButton = document.getElementById('closeDescriptionModal');
    const descriptionContent = document.getElementById('descriptionContent');
    const descriptionMessage = document.getElementById('descriptionMessage');
    const descriptionLoading = document.getElementById('descriptionLoading');
    const downloadBtn = document.getElementById('downloadBtn');
    const downloadSingleQrBtn = document.getElementById('downloadSingleQrBtn');
    const enlargedQrContainer = document.getElementById('enlargedQrContainer');
    const downloadAllQrBtn = document.getElementById('downloadAllQrBtn');
    const nameTagsContainer = document.getElementById('nameTags');
    let lastClickTime = 0;
    let clickCount = 0;
    let currentDownloadBlob = null;
    let currentDownloadFilename = null;
    let allLinksData = [];
    let currentQrDataUrl = null;
    let currentQrFilename = null;
    function showStatus(message, type = 'error') {
      statusPopup.textContent = message;
      statusPopup.className = type === 'error' ? 'bg-red-600' : 'bg-green-600';
      statusPopup.classList.add('opacity-100');
      setTimeout(() => statusPopup.classList.remove('opacity-100'), 3000);
    }
    async function generateQrCodeWithPadding(data, size = 256, padding = 4) {
        const canvas = document.createElement('canvas');
        await QRCode.toCanvas(canvas, data, { errorCorrectionLevel: 'H', margin: 0, width: size });
        const ctx = canvas.getContext('2d');
        const qrSize = canvas.width;
        const totalSize = qrSize + 2 * padding;
        const finalCanvas = document.createElement('canvas');
        finalCanvas.width = totalSize;
        finalCanvas.height = totalSize;
        const finalCtx = finalCanvas.getContext('2d');
        finalCtx.fillStyle = '#FFFFFF';
        finalCtx.fillRect(0, 0, totalSize, totalSize);
        finalCtx.drawImage(canvas, padding, padding, qrSize, qrSize);
        return finalCanvas;
    }
    function downloadQrCode(canvas, filename) {
        if (!canvas) return showStatus('Gagal membuat QR Code', 'error');
        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/png');
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showStatus(`${filename} berhasil diunduh`, 'success');
    }
    async function downloadAllQRCodes() {
        if (allLinksData.length === 0) return showStatus('Tidak ada data', 'error');
        const zip = new JSZip();
        const promises = [];
        downloadAllQrBtn.disabled = true;
        downloadAllQrBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Memproses...';
        showStatus('Membuat ZIP QR Code...', 'success');
        for (const link of allLinksData) {
            const qrData = `${link.url || ''} || ${link.shift_code || ''}`;
            let filename = `${link.person_name || 'anonim'} - ${link.name || 'tanpa-nama'}.png`;
            filename = filename.replace(/[^a-zA-Z0-9\s-.]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-').replace(/^-+|-+$/g, '');
            const promise = generateQrCodeWithPadding(qrData, 512, 20).then(canvas => new Promise(resolve => {
                canvas.toBlob(blob => { zip.file(filename, blob); resolve(); }, 'image/png');
            }));
            promises.push(promise);
        }
        await Promise.all(promises);
        zip.generateAsync({ type: 'blob' }).then(content => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(content);
            a.download = 'Semua_QR_Codes.zip';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showStatus('ZIP QR Code selesai!', 'success');
        }).finally(() => {
            downloadAllQrBtn.disabled = false;
            downloadAllQrBtn.innerHTML = '<i class="fa-solid fa-file-zipper"></i> <span class="hidden sm:inline">Unduh Semua QR</span>';
        });
    }
    downloadAllQrBtn.addEventListener('click', downloadAllQRCodes);
    function decryptCaesar(text, shift) {
      if (typeof text !== 'string') return text;
      const s = Number(shift);
      if (isNaN(s)) return text;
      let result = '';
      for (let i = 0; i < text.length; i++) {
        let code = text.charCodeAt(i);
        if (code >= 65 && code <= 90) code = ((code - 65 - s + 260) % 26) + 65;
        else if (code >= 97 && code <= 122) code = ((code - 97 - s + 260) % 26) + 97;
        result += String.fromCharCode(code);
      }
      return result;
    }
    function normalizeBase64(b64) {
      if (!b64 || typeof b64 !== 'string') return '';
      let s = b64.replace(/\s+/g, '');
      const dataMatch = s.match(/^data:.*;base64,(.*)$/i);
      if (dataMatch) s = dataMatch[1];
      s = s.replace(/-/g, '+').replace(/_/g, '/');
      const pad = s.length % 4;
      if (pad === 2) s += '=='; else if (pad === 3) s += '=';
      return s;
    }
    function isBase64String(s) {
      if (!s || typeof s !== 'string') return false;
      const cleaned = normalizeBase64(s);
      return cleaned.length % 4 === 0 && /^[A-Za-z0-9+/=]+$/.test(cleaned);
    }
    function getMimeFromBase64Sample(b64) {
      try {
        const cleaned = normalizeBase64(b64).slice(0,2000);
        if (!cleaned) return null;
        const bin = atob(cleaned);
        const c0 = bin.charCodeAt(0), c1 = bin.charCodeAt(1);
        if (c0 === 0x89 && bin[1] === 'P' && bin[2] === 'N' && bin[3] === 'G') return 'image/png';
        if (c0 === 0xFF && c1 === 0xD8) return 'image/jpeg';
        if (bin.startsWith('GIF87a') || bin.startsWith('GIF89a')) return 'image/gif';
        if (bin.trim().startsWith('<svg')) return 'image/svg+xml';
        if (bin.indexOf('ftyp') !== -1) return 'video/mp4';
        if (bin.toLowerCase().indexOf('webm') !== -1) return 'video/webm';
        const prefix = normalizeBase64(b64).slice(0,8);
        if (prefix.startsWith('iVBOR') || prefix.startsWith('iVBORw0K')) return 'image/png';
        if (prefix.startsWith('/9j/')) return 'image/jpeg';
        if (prefix.startsWith('R0lG')) return 'image/gif';
        return null;
      } catch (e) { return null; }
    }
    function base64ToBlob(base64, mime) {
      const binary = atob(base64);
      const len = binary.length;
      const arr = new Uint8Array(len);
      for (let i=0;i<len;i++) arr[i] = binary.charCodeAt(i);
      return new Blob([arr], { type: mime || 'application/octet-stream'});
    }
    function setPreviewFromBase64(rawBase64, mimeHint, useBlobIfLarge = true) {
      const cleaned = normalizeBase64(rawBase64);
      if (!cleaned) { descriptionContent.innerHTML = '<p class="text-red-500">Data base64 kosong.</p>'; return; }
      let mime = mimeHint || getMimeFromBase64Sample(cleaned);
      if (!mime) {
        if (cleaned.startsWith('iVBOR') || cleaned.startsWith('iVBORw0K')) mime = 'image/png';
        else if (cleaned.startsWith('/9j/')) mime = 'image/jpeg';
        else if (cleaned.startsWith('R0lG')) mime = 'image/gif';
      }
      descriptionContent.innerHTML = '';
      const threshold = 1024 * 300;
      const approximateSize = Math.ceil((cleaned.length * 3) / 4);
      let blob = null;
      if (useBlobIfLarge && approximateSize > threshold) {
        try {
          blob = base64ToBlob(cleaned, mime);
          const objectUrl = URL.createObjectURL(blob);
          if (mime && mime.startsWith('image/')) {
            const img = document.createElement('img');
            img.src = objectUrl;
            img.className = 'media-preview rounded-xl border border-gray-200 max-w-full';
            img.onload = () => URL.revokeObjectURL(objectUrl);
            descriptionContent.appendChild(img);
          } else if (mime && mime.startsWith('video/')) {
            const video = document.createElement('video');
            video.src = objectUrl;
            video.controls = true;
            video.className = 'video-preview rounded-xl border border-gray-200 max-w-full';
            video.onloadeddata = () => URL.revokeObjectURL(objectUrl);
            descriptionContent.appendChild(video);
          }
        } catch (err) { blob = null; }
      }
      if (!blob) {
        const dataMime = mime || 'application/octet-stream';
        const dataUrl = `data:${dataMime};base64,${cleaned}`;
        if (dataMime.startsWith('image/')) {
          const img = document.createElement('img');
          img.src = dataUrl;
          img.className = 'media-preview rounded-xl border border-gray-200 max-w-full';
          descriptionContent.appendChild(img);
        } else if (dataMime.startsWith('video/')) {
          const video = document.createElement('video');
          video.src = dataUrl;
          video.controls = true;
          video.className = 'video-preview rounded-xl border border-gray-200 max-w-full';
          video.setAttribute('playsinline', '');
          descriptionContent.appendChild(video);
        }
      }
      return { blob: blob, mime: mime };
    }
    async function showDescriptionModal(url, shiftCode, personName, linkName) {
      descriptionModal.classList.remove('hidden');
      descriptionContent.innerHTML = '';
      descriptionMessage.classList.add('hidden');
      descriptionLoading.classList.remove('hidden');
      downloadBtn.classList.add('hidden');
      try {
        if (!url || !url.startsWith('http')) throw new Error('URL tidak valid');
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Gagal memuat (status ${response.status})`);
        const encryptedText = await response.text();
        const decrypted = decryptCaesar(encryptedText, shiftCode);
        const probableBase64 = decrypted.trim();
        const mimeHint = getMimeFromBase64Sample(probableBase64);
        const previewResult = setPreviewFromBase64(probableBase64, mimeHint, true);
        const blob = previewResult.blob;
        const mime = previewResult.mime;
        if (isBase64String(probableBase64)) {
          const fileExt = mime ? mime.split('/')[1] : 'bin';
          let baseFilename = `${personName || 'anonim'} - ${linkName || 'tanpa-nama'}`;
          baseFilename = baseFilename.replace(/[^a-zA-Z0-9\s-.]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-').replace(/^-+|-+$/g, '');
          currentDownloadFilename = `${baseFilename}.${fileExt}`;
          currentDownloadBlob = blob;
        } else {
          currentDownloadBlob = new Blob([decrypted], { type: 'text/plain' });
          currentDownloadFilename = `${personName || 'anonim'} - ${linkName || 'tanpa-nama'}.txt`;
        }
        downloadBtn.classList.remove('hidden');
        descriptionLoading.classList.add('hidden');
      } catch (error) {
        descriptionMessage.textContent = `Gagal: ${error.message}`;
        descriptionLoading.classList.add('hidden');
        descriptionMessage.classList.remove('hidden');
      }
    }
    function hideDescriptionModal() {
      descriptionModal.classList.add('hidden');
      descriptionContent.innerHTML = '';
      descriptionMessage.classList.add('hidden');
      descriptionLoading.classList.add('hidden');
      downloadBtn.classList.add('hidden');
      if (currentDownloadBlob) {
        URL.revokeObjectURL(URL.createObjectURL(currentDownloadBlob));
        currentDownloadBlob = null;
        currentDownloadFilename = null;
      }
    }
    closeModalButton.addEventListener('click', () => qrModal.classList.add('hidden'));
    qrModal.addEventListener('click', e => e.target === qrModal && qrModal.classList.add('hidden'));
    closeDescriptionModalButton.addEventListener('click', hideDescriptionModal);
    descriptionModal.addEventListener('click', e => e.target === descriptionModal && hideDescriptionModal());
    downloadSingleQrBtn.addEventListener('click', () => {
        const canvas = enlargedQrContainer.querySelector('canvas');
        if (canvas && currentQrFilename) downloadQrCode(canvas, currentQrFilename);
    });
    downloadBtn.addEventListener('click', () => {
      if (currentDownloadBlob) {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(currentDownloadBlob);
        a.download = currentDownloadFilename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    });
    function filterLinks() {
      const term = searchInput.value.toLowerCase().trim();
      const rows = linksTableBody.querySelectorAll('tr');
      rows.forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
      });
      document.querySelectorAll('.name-tag').forEach(t => t.classList.remove('active'));
      if (term) {
        const active = Array.from(document.querySelectorAll('.name-tag')).find(t => t.textContent.toLowerCase() === term);
        if (active) active.classList.add('active');
      }
      clearSearchBtn.classList.toggle('hidden', !term);
    }
    searchInput.addEventListener('input', filterLinks);
    clearSearchBtn.addEventListener('click', () => { searchInput.value = ''; filterLinks(); });
    async function handleEdit(e) {
        const cell = e.target;
        if (!cell.classList.contains('editable')) return;
        cell.contentEditable = 'false';
        cell.classList.remove('editable');
        cell.removeEventListener('keydown', handleEnter);
        cell.removeEventListener('blur', handleEdit);
        const newText = cell.textContent.trim();
        const row = cell.closest('tr');
        const linkId = row.dataset.id;
        const column = cell.dataset.column;
        if (!linkId || !column) return showStatus('Gagal update', 'error');
        const updates = {}; updates[column] = newText;
        showStatus('Menyimpan...', 'success');
        try {
            const { error } = await supabase.from('links').update(updates).eq('id', linkId);
            if (error) throw error;
            showStatus('Tersimpan!', 'success');
            if (column === 'url' || column === 'shift_code') fetchLinks();
        } catch (error) {
            showStatus(`Gagal: ${error.message}`, 'error');
        }
    }
    function handleEnter(e) { if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); } }
    async function handleDelete(e) {
        const row = e.target.closest('tr');
        const linkId = row.dataset.id;
        if (!linkId) return showStatus('ID tidak ditemukan', 'error');
        if (!confirm('Hapus tautan ini?')) return;
        showStatus('Menghapus...', 'success');
        try {
            const { error } = await supabase.from('links').delete().eq('id', linkId);
            if (error) throw error;
            showStatus('Terhapus!', 'success');
            row.remove();
            fetchLinks();
        } catch (error) {
            showStatus(`Gagal: ${error.message}`, 'error');
        }
    }
    async function fetchLinks() {
      loadingIndicator.classList.remove('hidden');
      linksTableBody.innerHTML = '';
      allLinksData = [];
      nameTagsContainer.innerHTML = '';
      try {
        const { data, error } = await supabase.from('links').select('*, category').order('created_at', { ascending: false });
        loadingIndicator.classList.add('hidden');
        if (error) throw error;
        if (!data || data.length === 0) return;
        allLinksData = data;
        const uniqueNames = [...new Set(data.map(l => l.person_name).filter(Boolean))].sort((a,b) => a.localeCompare(b,'id',{sensitivity:'base'}));
        uniqueNames.forEach(name => {
          const tag = document.createElement('span');
          tag.className = 'name-tag';
          tag.textContent = name;
          tag.addEventListener('click', () => {
            searchInput.value = name;
            filterLinks();
            document.querySelectorAll('.name-tag').forEach(t => t.classList.remove('active'));
            tag.classList.add('active');
          });
          nameTagsContainer.appendChild(tag);
        });
        if (uniqueNames.length === 0) nameTagsContainer.innerHTML = '<span class="text-slate-500">Belum ada nama terdaftar</span>';
        data.forEach(link => {
          const row = document.createElement('tr');
          row.classList.add('hover:bg-sky-50');
          row.dataset.id = link.id;
          const formattedDate = link.created_at ? new Date(link.created_at).toLocaleString('id-ID') : '-';
          const qrData = `${link.url || ''} || ${link.shift_code || ''}`;
          const category = link.category || 'Belum Dikategorikan';
          let qrFilenameBase = `${link.person_name || 'anonim'} - ${link.name || 'tanpa-nama'}`;
          qrFilenameBase = qrFilenameBase.replace(/[^a-zA-Z0-9\s-.]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-').replace(/^-+|-+$/g, '');
          const smallQrId = `qr-${link.id}`;
          row.innerHTML = `
            <td class="px-6 py-5 text-center qr-cell"><canvas id="${smallQrId}" class="inline-block" style="width:80px;height:80px;"></canvas></td>
            <td class="px-6 py-5 font-medium" data-column="person_name">${link.person_name || '-'}</td>
            <td class="px-6 py-5" data-column="name">${link.name || '-'}</td>
            <td class="px-6 py-5" data-column="category">${category}</td>
            <td class="px-6 py-5 truncate max-w-xs" data-column="url">${link.url || '-'}</td>
            <td class="px-6 py-5" data-column="shift_code">${link.shift_code || '-'}</td>
            <td class="px-6 py-5 text-sm text-slate-500">${formattedDate}</td>
            <td class="px-6 py-5 text-center"><button class="view-description-btn bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition font-medium">Lihat</button></td>
            <td class="px-6 py-5 text-center"><button class="delete-btn text-red-600 hover:text-red-800 text-2xl"><i class="fa-solid fa-trash-can"></i></button></td>
          `;
          linksTableBody.appendChild(row);
          QRCode.toCanvas(document.getElementById(smallQrId), qrData, { errorCorrectionLevel: 'L', margin: 1, width: 80, color: { dark: '#000000', light: '#ffffff' } });
          row.querySelector(`#${smallQrId}`).addEventListener('click', () => {
            enlargedQrContainer.innerHTML = '';
            generateQrCodeWithPadding(qrData, 280, 20).then(canvas => {
                enlargedQrContainer.appendChild(canvas);
                currentQrFilename = `${qrFilenameBase}.png`;
                qrModal.classList.remove('hidden');
            });
          });
          row.querySelector('.view-description-btn').addEventListener('click', () => {
            const urlParam = encodeURIComponent(link.url || '');
            const shiftParam = encodeURIComponent(link.shift_code || '');
            const personParam = encodeURIComponent(link.person_name || '');
            const nameParam = encodeURIComponent(link.name || '');
            window.open(`dekripsi.html?url=${urlParam}&shift=${shiftParam}&person=${personParam}&name=${nameParam}`, '_blank');
          });
          row.querySelector('.delete-btn').addEventListener('click', handleDelete);
          row.querySelectorAll('td[data-column]').forEach(cell => {
            cell.addEventListener('click', e => {
              const now = Date.now();
              clickCount = (now - lastClickTime < 300 && clickCount < 3) ? clickCount + 1 : 1;
              lastClickTime = now;
              if (clickCount === 3) {
                e.preventDefault();
                cell.contentEditable = 'true';
                cell.classList.add('editable');
                cell.focus();
                cell.addEventListener('blur', handleEdit);
                cell.addEventListener('keydown', handleEnter);
              }
            });
          });
        });
      } catch (err) {
        loadingIndicator.classList.add('hidden');
        showStatus('Gagal memuat data', 'error');
      }
    }
    document.addEventListener('DOMContentLoaded', fetchLinks);
  </script>
</body>
</html>
