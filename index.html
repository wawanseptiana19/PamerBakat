<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Advanced HTML Runner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/material-darker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/eclipse.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.5/dist/sweetalert2.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; }
        .CodeMirror { height: 300px; }
        .nav-tabs .nav-link { font-weight: bold; }
        #preview { border: 1px solid #ced4da; border-radius: 0.25rem; width: 100%; height: 400px; background-color: white; }
        #loading { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; background-color: rgba(255,255,255,0.8); border-radius: 5px; font-size: 20px; z-index: 1000; }
    </style>
</head>
<body>
<div class="container">
    <div class="mb-4 text-center">
        <h1>Advanced HTML Runner</h1>
        <p>Editor dengan preview real-time, Supabase, dan impor kode</p>
    </div>

    <ul class="nav nav-tabs" id="editorTab">
        <li class="nav-item"><button class="nav-link active" id="html-tab" data-bs-toggle="tab" data-bs-target="#html">HTML</button></li>
        <li class="nav-item"><button class="nav-link" id="css-tab" data-bs-toggle="tab" data-bs-target="#css">CSS</button></li>
        <li class="nav-item"><button class="nav-link" id="js-tab" data-bs-toggle="tab" data-bs-target="#js">JavaScript</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="html"><textarea id="htmlEditor"></textarea></div>
        <div class="tab-pane fade" id="css"><textarea id="cssEditor"></textarea></div>
        <div class="tab-pane fade" id="js"><textarea id="jsEditor"></textarea></div>
    </div>

    <div class="mt-3 d-flex flex-wrap gap-2">
        <button class="btn btn-success flex-fill" onclick="downloadCode()">Download Kode</button>
        <button class="btn btn-secondary flex-fill" onclick="resetCode()">Reset Editor</button>
        <button class="btn btn-warning flex-fill" onclick="clearAutosave()">Hapus Autosave</button>
        <button class="btn btn-success flex-fill" onclick="saveToSupabase()">Simpan ke Supabase</button>
        <button class="btn btn-primary flex-fill" onclick="loadFromSupabase()">Load dari Supabase</button>
        <!-- Impor Kode -->
        <label class="btn btn-info flex-fill mb-0">
            Impor Kode
            <input type="file" id="importCodeFile" accept=".txt,.html" style="display:none" onchange="importCodeFromFile(event)">
        </label>
    </div>

    <div class="mt-4">
        <h4>Preview</h4>
        <iframe id="preview" title="Preview Output"></iframe>
    </div>

    <!-- Tombol Buka Tab Baru di paling bawah -->
    <div class="mt-3">
        <button class="btn btn-dark w-100" onclick="openMenuInNewTab()">Buka di Tab Baru</button>
    </div>
</div>

<div id="loading">Loading...</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.5/dist/sweetalert2.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.js"></script>
<script>
    // Inisialisasi editor
    var htmlEditor = CodeMirror.fromTextArea(document.getElementById("htmlEditor"), {mode: "htmlmixed", theme: "material-darker", lineNumbers: true});
    var cssEditor = CodeMirror.fromTextArea(document.getElementById("cssEditor"), {mode: "css", theme: "material-darker", lineNumbers: true});
    var jsEditor = CodeMirror.fromTextArea(document.getElementById("jsEditor"), {mode: "javascript", theme: "material-darker", lineNumbers: true});

    // Fungsi debounce agar tidak double run
    function debounce(func, delay) {
        let timer;
        return function(...args) {
            clearTimeout(timer);
            timer = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // Jalankan otomatis setiap ada perubahan di editor (1 listener saja)
    const autoRun = debounce(() => runCode(), 500);
    htmlEditor.on("change", autoRun);
    cssEditor.on("change", autoRun);
    jsEditor.on("change", autoRun);

    function runCode() {
        showLoading();
        const htmlContent = htmlEditor.getValue();
        const cssContent = "<style>" + cssEditor.getValue() + "</style>";
        const jsContent = "<script>" + jsEditor.getValue() + "<\/script>";
        document.getElementById("preview").srcdoc = htmlContent + cssContent + jsContent;
        autosaveCode();
        hideLoading();
    }

    function downloadCode() {
        const blob = new Blob([htmlEditor.getValue() + "<style>" + cssEditor.getValue() + "</style>" + "<script>" + jsEditor.getValue() + "<\/script>"], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'kode.html';
        a.click();
        showToast('Kode berhasil diunduh!', 'success');
    }

    function resetCode() {
        Swal.fire({title: 'Reset Editor?', text: "Semua kode akan dihapus.", icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya, Reset!'})
        .then((result) => {
            if (result.isConfirmed) {
                htmlEditor.setValue("");
                cssEditor.setValue("");
                jsEditor.setValue("");
                document.getElementById("preview").srcdoc = "";
                autosaveCode();
                showToast('Editor telah direset.', 'success');
            }
        });
    }

    function autosaveCode() {
        localStorage.setItem("advancedHtmlRunnerCode", JSON.stringify({ html: htmlEditor.getValue(), css: cssEditor.getValue(), js: jsEditor.getValue() }));
    }

    function loadAutosave() {
        const saved = localStorage.getItem("advancedHtmlRunnerCode");
        if (saved) {
            const codeData = JSON.parse(saved);
            htmlEditor.setValue(codeData.html || "");
            cssEditor.setValue(codeData.css || "");
            jsEditor.setValue(codeData.js || "");
            runCode();
        }
    }

    function clearAutosave() {
        localStorage.removeItem("advancedHtmlRunnerCode");
        showToast('Autosave dihapus.', 'success');
    }

    function showToast(message, type = 'success') {
        Toastify({ text: message, duration: 3000, close: true, backgroundColor: type === 'success' ? "#4caf50" : "#f44336"}).showToast();
    }

    function showLoading() { document.getElementById('loading').style.display = 'block'; }
    function hideLoading() { document.getElementById('loading').style.display = 'none'; }

    const SUPABASE_URL = "https://vlrglwotjlfamnpzaeir.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZscmdsd290amxmYW1ucHphZWlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNjYzMzYsImV4cCI6MjA3MDg0MjMzNn0.cwHu4vQlulKZQwNHD7ENT2zN_rZG4LkEQxJTjlIT12Q";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const TABLE_NAME = "html_codes";

    async function saveToSupabase() {
        showLoading();
        const { error } = await supabase.from(TABLE_NAME).upsert([{ id: 1, html: htmlEditor.getValue(), css: cssEditor.getValue(), js: jsEditor.getValue() }], { onConflict: ['id'] });
        hideLoading();
        if (error) { showToast("Gagal menyimpan ke Supabase", "error"); console.error(error); }
        else { showToast("Kode berhasil disimpan ke Supabase", "success"); }
    }

    async function loadFromSupabase() {
        showLoading();
        const { data, error } = await supabase.from(TABLE_NAME).select("*").eq("id", 1).single();
        hideLoading();
        if (error || !data) { showToast("Gagal memuat dari Supabase", "error"); console.error(error); }
        else {
            htmlEditor.setValue(data.html || "");
            cssEditor.setValue(data.css || "");
            jsEditor.setValue(data.js || "");
            runCode();
            showToast("Kode berhasil dimuat dari Supabase", "success");
        }
    }

    function openMenuInNewTab() {
        const combinedCode = htmlEditor.getValue() + "<style>" + cssEditor.getValue() + "</style>" + "<script>" + jsEditor.getValue() + "<\/script>";
        const newTab = window.open();
        newTab.document.open();
        newTab.document.write(combinedCode);
        newTab.document.close();
    }

    function importCodeFromFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            htmlEditor.setValue(e.target.result);
            runCode();
            showToast("Kode berhasil diimpor!", "success");
        };
        reader.readAsText(file);
    }

    window.addEventListener("load", loadAutosave);
</script>
</body>
</html>
