<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dekripsi & Preview â€” Dekripsi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .container { max-width: 1000px; }
    .media-wrap { width: 100%; display:flex; flex-direction:column; gap:12px; align-items:center; }
    .controls-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .size-badge { background: #eef2ff; color:#3730a3; padding:6px 10px; border-radius:999px; font-weight:600; }
    /* overlay kunci (ditambahkan) */
    #lockedOverlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.75);
      z-index: 99999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      color: white;
    }
    #lockedBox {
      background: rgba(255,255,255,0.06);
      border-radius: 12px;
      padding: 20px;
      width: 100%;
      max-width: 640px;
      text-align: center;
      box-shadow: 0 8px 30px rgba(2,6,23,0.6);
      backdrop-filter: blur(4px);
    }
    #lockedBox h2 { font-size: 1.25rem; margin-bottom: 6px; }
    #lockedBox p { margin-bottom: 12px; color: #e6eef8; }
    /* Hide any leftover button styles (no buttons expected) */
    button { display: none !important; }
    a.button-like { display: none !important; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen py-8">
  <div class="container mx-auto px-4">
    <div class="bg-white shadow p-6 rounded-lg">
      <h1 class="text-2xl font-bold mb-2">Hasil Dekripsi & Preview</h1>
      <p class="text-sm text-gray-600 mb-4"></p>

      <div id="status" class="mb-4 text-sm text-gray-700">Memuat...</div>

      <div id="meta" class="mb-4 hidden">
        <div class="flex items-center gap-3">
          <div class="size-badge" id="fileSize">Ukuran: -</div>
          <div class="text-sm text-gray-600" id="detectedMime">Tipe: -</div>
        </div>
      </div>

      <div id="preview" class="mb-6"></div>

      <!-- Kontrol ukuran (range inputs tetap ada; bukan tombol) -->
      <div id="videoControls" class="mb-6 hidden">
        <label class="block text-sm font-medium text-gray-700 mb-2">Atur ukuran video</label>
        <div class="controls-row mb-2">
          <div id="sizeLabelVideo" class="text-sm text-gray-700 ml-3">100%</div>
        </div>
        <div class="controls-row items-center">
          <label class="text-sm text-gray-600 mr-2">Resize (persentase):</label>
          <input id="sizeRangeVideo" type="range" min="20" max="150" value="100" class="w-48">
        </div>
      </div>

      <div id="imageControls" class="mb-6 hidden">
        <label class="block text-sm font-medium text-gray-700 mb-2">Atur ukuran gambar</label>
        <div class="controls-row mb-2">
          <div id="sizeLabelImage" class="text-sm text-gray-700 ml-3">100%</div>
        </div>
        <div class="controls-row items-center">
          <label class="text-sm text-gray-600 mr-2">Resize (persentase):</label>
          <input id="sizeRangeImage" type="range" min="10" max="200" value="100" class="w-48">
        </div>
      </div>

    </div>

    <div class="text-sm text-gray-500 mt-4">
      <p>Parameter yang diterima: <code>?url=&lt;URL&gt;&amp;shift=&lt;angka&gt;&amp;person=&lt;nama&gt;&amp;name=&lt;judul&gt;</code></p>
      <p class="mt-2">Contoh: <code>dekripsi.html?url=https://example.com/file.txt&amp;shift=3</code></p>
    </div>
  </div>

  <!-- Locked overlay (ditampilkan bila akses tak valid) - tanpa tombol -->
  <div id="lockedOverlay" role="dialog" aria-modal="true">
    <div id="lockedBox" role="document">
      <h2>Akses Terkunci</h2>
      <p>Halaman dekripsi hanya bisa diakses setelah Anda masuk melalui halaman utama (index).</p>
      <p style="margin-top:10px;font-size:0.85rem;color:#dbeafe;">
        Sistem akan mencoba membuka halaman utama dan memeriksa status login secara otomatis.
        Jika browser memblokir pop-up, silakan buka "index.html" secara manual dan login, lalu kembali ke halaman ini.
      </p>
    </div>
  </div>

  <script>
    // Utility: ambil query param
    function q(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name) || '';
    }

    // Caesar decrypt (hanya huruf latin)
    function decryptCaesar(text, shift) {
      if (typeof text !== 'string') return text;
      const s = Number(shift);
      if (isNaN(s)) return text;
      let result = '';
      for (let i = 0; i < text.length; i++) {
        let code = text.charCodeAt(i);
        if (code >= 65 && code <= 90) {
          code = ((code - 65 - s + 260) % 26) + 65;
        } else if (code >= 97 && code <= 122) {
          code = ((code - 97 - s + 260) % 26) + 97;
        }
        result += String.fromCharCode(code);
      }
      return result;
    }

    // Normalisasi base64 (hapus header data:...;base64, jika ada)
    function normalizeBase64(b64) {
      if (!b64 || typeof b64 !== 'string') return '';
      let s = b64.replace(/\s+/g, '');
      const m = s.match(/^data:.*;base64,(.*)$/i);
      if (m) s = m[1];
      s = s.replace(/-/g, '+').replace(/_/g, '/');
      const pad = s.length % 4;
      if (pad === 2) s += '=='; else if (pad === 3) s += '=';
      return s;
    }

    // Convert base64 to Blob
    function base64ToBlob(base64, mime) {
      const cleaned = normalizeBase64(base64);
      const binary = atob(cleaned);
      const len = binary.length;
      const arr = new Uint8Array(len);
      for (let i = 0; i < len; i++) arr[i] = binary.charCodeAt(i);
      return new Blob([arr], { type: mime || 'application/octet-stream' });
    }

    // Deteksi mime dari sample awal base64 (heuristik)
    function detectMimeFromBase64(b64) {
      try {
        const cleaned = normalizeBase64(b64).slice(0, 2000);
        if (!cleaned) return null;
        const bin = atob(cleaned.slice(0, 1000));
        if (bin.startsWith('\x89PNG')) return 'image/png';
        if (bin.charCodeAt(0) === 0xFF && bin.charCodeAt(1) === 0xD8) return 'image/jpeg';
        if (bin.startsWith('GIF87a') || bin.startsWith('GIF89a')) return 'image/gif';
        if (bin.indexOf('ftyp') !== -1) return 'video/mp4';
        if (bin.toLowerCase().indexOf('webm') !== -1) return 'video/webm';
        if (cleaned.startsWith('iVBOR') || cleaned.startsWith('/9j/')) {
          if (cleaned.startsWith('iVBOR')) return 'image/png';
          if (cleaned.startsWith('/9j/')) return 'image/jpeg';
        }
        return null;
      } catch (e) {
        return null;
      }
    }

    // Format bytes ke MB dengan 2 desimal
    function bytesToMB(n) {
      if (typeof n !== 'number' || isNaN(n)) return '-';
      return (n / (1024 * 1024)).toFixed(2) + ' MB';
    }

    const lockedOverlay = document.getElementById('lockedOverlay');

    // Cek apakah opener (index) dalam keadaan "ter-unlock"
    function checkOpenerLoggedIn() {
      try {
        if (!window.opener || window.opener.closed) return false;

        // coba akses elemen overlay di index (jika ada)
        const overlay = window.opener.document.getElementById && window.opener.document.getElementById('loginOverlay');
        if (overlay) {
          const disp = String(overlay.style.display || '');
          if (disp === 'none' || disp === '') {
            const logoutBtn = window.opener.document.getElementById && window.opener.document.getElementById('logoutBtn');
            if (logoutBtn && logoutBtn.style.display !== 'none') return true;
            const pageContent = window.opener.document.getElementById && window.opener.document.getElementById('pageContent');
            if (pageContent && !pageContent.classList.contains('blurred')) return true;
            if (disp === 'none') return true;
          } else {
            if (disp === 'none') return true;
          }
        } else {
          const logoutBtn = window.opener.document.getElementById && window.opener.document.getElementById('logoutBtn');
          if (logoutBtn && logoutBtn.style.display !== 'none') return true;
          const pageContent = window.opener.document.getElementById && window.opener.document.getElementById('pageContent');
          if (pageContent && !pageContent.classList.contains('blurred')) return true;
        }

        return false;
      } catch (e) {
        // akses diblokir oleh same-origin policy atau opener dari origin lain
        return false;
      }
    }

    function showLockedOverlay() {
      if (lockedOverlay) lockedOverlay.style.display = 'flex';
      const previewEl = document.getElementById('preview');
      if (previewEl) previewEl.style.filter = 'blur(4px)';
    }
    function hideLockedOverlay() {
      if (lockedOverlay) lockedOverlay.style.display = 'none';
      const previewEl = document.getElementById('preview');
      if (previewEl) previewEl.style.filter = '';
    }

    // Polling untuk cek akses
    let accessInterval = null;
    function startAccessPolling() {
      if (accessInterval) return;
      accessInterval = setInterval(() => {
        if (checkOpenerLoggedIn()) {
          hideLockedOverlay();
          clearInterval(accessInterval);
          accessInterval = null;
          if (typeof ensureAndRunMain === 'function') ensureAndRunMain();
        }
      }, 700);
    }

    // Coba buka index otomatis (popup mungkin diblokir oleh browser)
    function tryOpenIndexAutomatically() {
      try {
        if (window.opener && !window.opener.closed) {
          // fokus opener jika tersedia
          try { window.opener.focus(); } catch(e){}
        } else {
          const w = window.open('index.html', '_blank');
          // jika popup berhasil, fokus window baru
          try { if (w) w.focus(); } catch(e){}
        }
      } catch (e) {
        // ignore
      }
    }

    // === FUNGSI UTAMA ===
    async function ensureAndRunMain() {
      if (ensureAndRunMain._started) return;
      ensureAndRunMain._started = true;

      const url = q('url');
      const shift = q('shift') || '0';
      const person = q('person') || '';
      const name = q('name') || '';

      const statusEl = document.getElementById('status');
      const previewEl = document.getElementById('preview');
      const metaEl = document.getElementById('meta');
      const fileSizeEl = document.getElementById('fileSize');
      const mimeEl = document.getElementById('detectedMime');

      const videoControls = document.getElementById('videoControls');
      const sizeRangeVideo = document.getElementById('sizeRangeVideo');
      const sizeLabelVideo = document.getElementById('sizeLabelVideo');

      const imageControls = document.getElementById('imageControls');
      const sizeRangeImage = document.getElementById('sizeRangeImage');
      const sizeLabelImage = document.getElementById('sizeLabelImage');

      let objectUrl = null;
      let currentBlob = null;
      let detectedMime = null;
      let videoEl = null;
      let imageEl = null;

      // apply saved settings if any
      try {
        const KEY_IMG = 'dekrip_image_size_pct';
        const KEY_VID = 'dekrip_video_size_pct';
        const savedImg = localStorage.getItem(KEY_IMG);
        const savedVid = localStorage.getItem(KEY_VID);
        if (savedImg !== null) {
          sizeRangeImage.value = savedImg;
          sizeLabelImage.textContent = savedImg + '%';
        }
        if (savedVid !== null) {
          sizeRangeVideo.value = savedVid;
          sizeLabelVideo.textContent = savedVid + '%';
        }
      } catch(e){}

      if (!url) {
        statusEl.textContent = 'Parameter url tidak ditemukan. Pastikan ?url= di query string.';
        return;
      }

      statusEl.textContent = 'Memuat file...';

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Gagal memuat file: ' + res.status);
        const encryptedText = await res.text();

        statusEl.textContent = 'Mendekripsi...';

        const decrypted = decryptCaesar(encryptedText, shift);
        const probableBase64 = decrypted.trim();

        const cleaned = normalizeBase64(probableBase64);
        const looksLikeBase64 = cleaned && /^[A-Za-z0-9+/=]+$/.test(cleaned);

        if (looksLikeBase64) {
          detectedMime = detectMimeFromBase64(cleaned) || '';
          try {
            currentBlob = base64ToBlob(cleaned, detectedMime || 'application/octet-stream');
          } catch (e) {
            currentBlob = null;
          }

          const approxBytes = Math.ceil((cleaned.length * 3) / 4);
          const bytesToShow = currentBlob ? currentBlob.size : approxBytes;
          fileSizeEl.textContent = 'Ukuran: ' + bytesToMB(bytesToShow);
          mimeEl.textContent = 'Tipe: ' + (detectedMime || 'Tidak terdeteksi');
          metaEl.classList.remove('hidden');

          if (currentBlob) objectUrl = URL.createObjectURL(currentBlob);
          else objectUrl = `data:${detectedMime || 'application/octet-stream'};base64,${cleaned}`;

          // MEDIA: Video
          if (detectedMime && detectedMime.startsWith('video/')) {
            previewEl.innerHTML = '';
            videoEl = document.createElement('video');
            videoEl.controls = true;
            videoEl.playsInline = true;
            videoEl.className = 'rounded-md shadow-sm';
            videoEl.style.maxWidth = '100%';
            const initPct = Number(sizeRangeVideo.value || 100);
            videoEl.style.width = initPct + '%';
            videoEl.src = objectUrl;
            // default loop on
            videoEl.loop = true;
            previewEl.appendChild(createLabel(`${person} - ${name}`));
            const wrap = document.createElement('div');
            wrap.className = 'media-wrap w-full';
            wrap.appendChild(videoEl);
            previewEl.appendChild(wrap);

            videoControls.classList.remove('hidden');
            imageControls.classList.add('hidden');

            sizeRangeVideo.addEventListener('input', () => {
              const val = Number(sizeRangeVideo.value);
              sizeLabelVideo.textContent = val + '%';
              videoEl.style.width = val + '%';
              try { localStorage.setItem('dekrip_video_size_pct', String(val)); } catch(e){}
            });

          // MEDIA: Image
          } else if (detectedMime && detectedMime.startsWith('image/')) {
            previewEl.innerHTML = '';
            imageEl = document.createElement('img');
            imageEl.src = objectUrl;
            imageEl.alt = `${person} - ${name}`;
            imageEl.className = 'rounded-md shadow-sm';
            imageEl.style.maxWidth = '100%';
            const initImgPct = Number(sizeRangeImage.value || 100);
            imageEl.style.width = initImgPct + '%';
            previewEl.appendChild(createLabel(`${person} - ${name}`));
            const wrap = document.createElement('div');
            wrap.className = 'media-wrap w-full';
            wrap.appendChild(imageEl);
            previewEl.appendChild(wrap);

            imageControls.classList.remove('hidden');
            videoControls.classList.add('hidden');

            sizeRangeImage.addEventListener('input', () => {
              const val = Number(sizeRangeImage.value);
              sizeLabelImage.textContent = val + '%';
              imageEl.style.width = val + '%';
              try { localStorage.setItem('dekrip_image_size_pct', String(val)); } catch(e){}
            });

          } else {
            // non-media base64 -> tampilkan preview teks terbatas
            previewEl.innerHTML = '';
            previewEl.appendChild(createLabel(`${person} - ${name}`));
            const pre = document.createElement('pre');
            pre.className = 'mt-3 p-3 bg-gray-50 rounded text-sm max-h-64 overflow-auto';
            pre.textContent = '[Preview base64 (dipotong)]\n' + cleaned.slice(0, 1500) + (cleaned.length > 1500 ? '\n\n... (terpotong) ...' : '');
            previewEl.appendChild(pre);
            videoControls.classList.add('hidden');
            imageControls.classList.add('hidden');
          }

        } else {
          // bukan base64 -> tampil sebagai teks biasa
          const textBlob = new Blob([decrypted], { type: 'text/plain' });
          const sizeBytes = textBlob.size;
          fileSizeEl.textContent = 'Ukuran: ' + bytesToMB(sizeBytes);
          mimeEl.textContent = 'Tipe: text/plain';
          metaEl.classList.remove('hidden');
          previewEl.innerHTML = '';
          previewEl.appendChild(createLabel(`${person} - ${name}`));
          const pre = document.createElement('pre');
          pre.className = 'mt-3 p-4 bg-gray-50 rounded text-sm whitespace-pre-wrap';
          pre.textContent = decrypted;
          previewEl.appendChild(pre);
          videoControls.classList.add('hidden');
          imageControls.classList.add('hidden');
        }

        statusEl.textContent = 'Selesai.';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Gagal memuat/mendekripsi: ' + err.message;
      }

      // revoke object URL on unload
      window.addEventListener('beforeunload', () => {
        if (objectUrl && objectUrl.startsWith('blob:')) URL.revokeObjectURL(objectUrl);
      });
    } // end ensureAndRunMain

    // Saat halaman dimuat: cek akses dari index terlebih dahulu.
    (function initAccessCheck() {
      if (checkOpenerLoggedIn()) {
        hideLockedOverlay();
        ensureAndRunMain();
      } else {
        // tampilkan overlay kunci, coba buka index otomatis, dan mulai polling
        showLockedOverlay();
        tryOpenIndexAutomatically();
        startAccessPolling();
      }

      // jika user kembali ke tab ini, periksa lagi
      window.addEventListener('focus', () => {
        if (checkOpenerLoggedIn()) {
          hideLockedOverlay();
          ensureAndRunMain();
        }
      });
    })();

    // helpers
    function createLabel(text) {
      const h = document.createElement('div');
      h.className = 'text-sm text-gray-700 font-semibold mb-2';
      h.textContent = text || '';
      return h;
    }
  </script>
</body>
</html>
