<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dekripsi & Preview — Dekripsi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- QRCode.js (sama seperti di index.html) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

  <!-- Supabase client -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.2/+esm';
    window.createClient = createClient;
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f7fafc; padding: 0; margin: 0; }
    .container { width: 100%; min-height: 100vh; display: flex; flex-direction: column; justify-content: flex-start; padding: 1.5rem; }
    #lockedOverlay { position: fixed; inset: 0; background: rgba(15,23,42,0.75); z-index: 99999; display: none; align-items: center; justify-content: center; padding: 1rem; color: white; }
    #lockedBox { background: rgba(255,255,255,0.06); border-radius: 12px; padding: 20px; width: 100%; max-width: 640px; text-align: center; box-shadow: 0 8px 30px rgba(2,6,23,0.6); backdrop-filter: blur(4px); }
    body.blurred .container { filter: blur(6px) saturate(0.95); transition: filter 0.25s ease; pointer-events: none; user-select: none; }
    .download-btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-weight: 500; transition: all 0.2s ease-in-out; text-decoration: none; }
    .download-btn.gray { background-color: #e5e7eb; color: #1f2937; }
    .download-btn.green { background-color: #10B981; color: #ffffff; box-shadow: 0 4px 6px rgba(16,185,129,0.25); }
    .download-btn.green:hover { background-color: #059669; }
    .frames-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem; width: 100%; }
    .frame-img { width: 100%; height: auto; border-radius: 0.375rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; }
    .category-group { margin-bottom: 1rem; }
    .category-heading { font-weight: 600; margin-bottom: 0.5rem; color: #374151; }
    .related-sublist { list-style-type: none; padding: 0; }
    .related-sublist li { padding: 0.75rem; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background-color 0.2s; }
    .related-sublist li:hover { background-color: #f3f4f6; }
    .related-sublist li:last-child { border-bottom: none; }
    #qrModal { display: none; position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
    #qrModal .modal-content { background: white; padding: 2rem; border-radius: 1rem; position: relative; text-align: center; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen py-8">
  <div class="container max-w-5xl mx-auto">
    <div class="p-6 md:p-10 bg-white rounded-xl shadow-lg">

      <h1 class="text-3xl font-bold text-gray-800 mb-2">Hasil Dekripsi & Preview</h1>
      <p class="text-sm text-gray-500 mb-6">Pratinjau konten Anda yang terdekripsi.</p>

      <!-- QR Code Section -->
      <div id="qrSection" class="text-center mb-10 hidden">
        <h2 class="text-xl font-semibold mb-4">QR Code untuk Konten Ini</h2>
        <canvas id="qrCanvas" class="mx-auto border-8 border-white shadow-2xl rounded-lg cursor-pointer"></canvas>
        <div class="mt-4">
          <button id="downloadQrBtn" class="download-btn green">Unduh QR Code</button>
        </div>
        <p class="text-xs text-gray-500 mt-3">Scan untuk membuka konten ini di perangkat lain</p>
      </div>

      <div id="status" class="mb-6 text-sm text-gray-700 bg-gray-100 p-3 rounded-lg flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4 text-gray-500">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
        </svg>
        Memuat...
      </div>

      <div id="preview" class="mb-8"></p></div>

      <div class="flex justify-center gap-4 mt-8">
        <a id="downloadOriginalBtn" class="download-btn gray hidden">
          Unduh .pb
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 ml-2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
          </svg>
        </a>
        <a id="downloadDecryptedBtn" class="download-btn green hidden">
          Unduh Dekripsi
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 ml-2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
          </svg>
        </a>
      </div>

      <div id="meta" class="mt-6 flex items-center justify-center flex-wrap gap-4 text-sm text-gray-600 hidden">…</div>

      <div id="videoControls" class="mb-6 hidden">…</div>
      <div id="imageControls" class="mb-6 hidden">…</div>
      <div id="framesPreview" class="mb-8 hidden">…</div>

      <!-- Konten Terkait -->
      <div id="relatedSection" class="hidden mt-12">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Konten Terkait</h2>
        <div id="relatedList"></div>
      </div>

    </div>
  </div>

  <!-- Locked Overlay -->
  <div id="lockedOverlay" role="dialog" aria-modal="true">
    <div id="lockedBox" role="document">
      <h2>Akses Terkunci</h2>
      <p>Login terlebih dahulu untuk melihat konten ini.</p>
    </div>
  </div>

  <!-- Modal QR Besar -->
  <div id="qrModal">
    <div class="modal-content">
      <button id="closeQrModal" class="absolute top-4 right-6 text-4xl text-gray-600 hover:text-gray-900">&times;</button>
      <canvas id="qrCanvasLarge" class="mx-auto border-8 border-white shadow-2xl rounded-lg"></canvas>
      <button id="downloadQrModalBtn" class="mt-6 download-btn green">Unduh QR Code (Besar)</button>
    </div>
  </div>

  <!-- Image Modal (frame) -->
  <div id="imageModal">…</div>

  <script>
    // ==== Semua utility function asli (tidak diubah) ====
    function q(name) { const params = new URLSearchParams(window.location.search); return params.get(name) || ''; }
    function decryptCaesar(text, shift) { /* kode asli */ }
    function normalizeBase64(b64) { /* kode asli */ }
    function base64ToBlob(base64, mime) { /* kode asli */ }
    function detectMimeFromBase64(b64) { /* kode asli */ }
    function bytesToMB(n) { return (n / (1024*1024)).toFixed(2) + ' MB'; }
    function createLabel(text) { const h = document.createElement('div'); h.className = 'text-sm text-gray-700 font-semibold mb-2'; h.textContent = text; return h; }

    const lockedOverlay = document.getElementById('lockedOverlay');
    function showLockedOverlay() { lockedOverlay.style.display = 'flex'; document.body.classList.add('blurred'); }
    function hideLockedOverlay() { lockedOverlay.style.display = 'none'; document.body.classList.remove('blurred'); }
    function isLoggedIn() { return localStorage.getItem('dekrip_logged_in') === 'true'; }

    // ==== Generate QR Code ====
    async function generateQR(url, shift) {
      const qrData = `${url} || ${shift}`;
      const smallCanvas = document.getElementById('qrCanvas');
      const largeCanvas = document.getElementById('qrCanvasLarge');

      await QRCode.toCanvas(smallCanvas, qrData, { width: 240, margin: 2, errorCorrectionLevel: 'H' });
      document.getElementById('qrSection').classList.remove('hidden');

      smallCanvas.onclick = async () => {
        document.getElementById('qrModal').style.display = 'flex';
        largeCanvas.width = 480; largeCanvas.height = 480;
        await QRCode.toCanvas(largeCanvas, qrData, { width: 480, margin: 4, errorCorrectionLevel: 'H' });
      };

      const downloadQr = (canvas, filename) => {
        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/png');
        a.download = filename;
        a.click();
      };

      document.getElementById('downloadQrBtn').onclick = () => downloadQr(smallCanvas, 'QR_Konten.png');
      document.getElementById('downloadQrModalBtn').onclick = () => downloadQr(largeCanvas, 'QR_Konten_Besar.png');
      document.getElementById('closeQrModal').onclick = () => document.getElementById('qrModal').style.display = 'none';
    }

    // ==== Fetch Konten Terkait (klik tetap di tab yang sama) ====
    async function fetchRelatedLinks(person) {
      // ... kode fetch Supabase sampai bagian render tetap sama ...

      // Hanya bagian klik yang diubah:
      li.addEventListener('click', () => {
        const targetUrl = `dekripsi.html?url=${encodeURIComponent(item.url)}&shift=${encodeURIComponent(item.shift_code)}&person=${encodeURIComponent(item.person_name)}&name=${encodeURIComponent(item.name)}`;
        window.location.href = targetUrl;   // reload halaman yang sama
      });
    }

    // ==== loadAndDecrypt (panggil generateQR di akhir) ====
    async function loadAndDecrypt(url, shift, person, name) {
      // ... semua kode dekripsi dan preview Anda yang lama (tidak ada perubahan) ...

      // Setelah status "Selesai." dan tombol download muncul:
      statusEl.innerHTML = `<svg ...> Selesai.</svg>`;
      // ... setup download links ...

      // Tambahan: buat QR Code
      generateQR(url, shift);
    }

    // ==== Init ====
    (function initAccessCheck() {
      if (isLoggedIn()) {
        hideLockedOverlay();
        ensureAndRunMain();
      } else {
        showLockedOverlay();
      }
      window.addEventListener('focus', () => {
        if (isLoggedIn()) { hideLockedOverlay(); ensureAndRunMain(); }
      });
    })();
  </script>
</body>
</html>
