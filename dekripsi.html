<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dekripsi & Preview</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {font-family: 'Inter', sans-serif;background-color: #f9fafb;}
    .card {background: white;border-radius: 1rem;box-shadow: 0 10px 25px rgba(0,0,0,0.08);overflow: hidden;}
    .media-wrap img, .media-wrap video {max-width: 100%;height: auto;border-radius: .75rem;box-shadow: 0 4px 12px rgba(0,0,0,.1);}
    #lockedOverlay {position: fixed;inset: 0;background: rgba(15,23,42,.85);z-index: 99999;display: flex;align-items: center;justify-content: center;padding: 1rem;color: white;}
    #lockedBox {background: white;color: #1f2937;padding: 2.5rem;border-radius: 1rem;max-width: 460px;width: 100%;text-align: center;}
    body.blurred .container {filter: blur(8px);transition: filter .3s;}
  </style>
</head>
<body class="min-h-screen py-8 px-4">
  <div class="container max-w-5xl mx-auto">

    <div class="card mb-8">
      <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-8 rounded-t-xl">
        <h1 class="text-3xl font-bold">Hasil Dekripsi & Preview</h1>
        <p class="opacity-90 mt-2">Konten telah berhasil didekripsi dan siap digunakan</p>
      </div>

      <div class="p-8">
        <div id="status" class="flex items-center gap-3 text-sm font-medium text-indigo-700 mb-8">
          <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Memuat...
        </div>

        <div id="preview" class="flex flex-col items-center"></div>

        <div id="meta" class="mt-8 flex flex-wrap justify-center gap-8 text-sm text-gray-600">
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2a2 2 0 00-2 2v3a2 2 0 002 2h2m-8-11h4"/></svg>
            <span id="fileSize">Ukuran: –</span>
          </div>
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            <span id="detectedMime">Tipe: –</span>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-8">
      <div class="p-6 flex flex-col sm:flex-row gap-4 justify-center">
        <a id="downloadOriginalBtn" class="hidden inline-flex items-center justify-center gap-3 bg-gray-700 hover:bg-gray-800 text-white font-medium py-3 px-8 rounded-lg transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m-4-6h8m5 8v2a2 2 0 01-2 2H5a2 2 0 01-2-2v-2m16 0H3"/></svg>
          Unduh File Asli (.pb)
        </a>
        <a id="downloadDecryptedBtn" class="hidden inline-flex items-center justify-center gap-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-medium py-3 px-8 rounded-lg transition shadow-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
          Unduh Hasil Dekripsi
        </a>
      </div>
    </div>

    <div id="qrSection" class="card mb-8 text-center hidden">
      <div class="p-10">
        <h2 class="text-2xl font-bold mb-4">QR Code Akses Cepat</h2>
        <p class="text-gray-600 mb-8">Scan untuk langsung membuka konten ini</p>
        <div class="inline-block bg-white p-12 rounded-2xl shadow-2xl">
          <canvas id="qrCanvas"></canvas>
        </div>
        <div class="mt-8">
          <button id="downloadQrBtn" class="inline-flex items-center gap-3 bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-10 rounded-lg transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
            Unduh QR Code
          </button>
        </div>
      </div>
    </div>

    <div id="relatedSection" class="card hidden">
      <div class="p-6">
        <button id="toggleRelated" class="w-full text-left text-2xl font-bold flex justify-between items-center font-bold text-gray-800 hover:text-gray-900">
          Konten Terkait
          <svg id="chevron" class="w-6 h-6 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        </button>
        <div id="relatedList" class="mt-6 space-y-3 hidden"></div>
      </div>
    </div>

  </div>

  <div id="lockedOverlay" role="dialog" aria-modal="true">
    <div id="lockedBox">
      <h2 class="text-3xl font-bold mb-4 text-gray-800">Akses Terkunci</h2>
      <p class="text-lg">Login terlebih dahulu di halaman utama untuk melihat konten ini.</p>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.2/+esm';
    window.createClient = createClient;

    function q(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name) || '';
    }

    function decryptCaesar(text, shift) {
      if (typeof text !== 'string') return text;
      const s = Number(shift);
      if (isNaN(s)) return text;
      let result = '';
      for (let i = 0; i < text.length; i++) {
        let code = text.charCodeAt(i);
        if (code >= 65 && code <= 90) code = ((code - 65 - s + 260) % 26) + 65;
        else if (code >= 97 && code <= 122) code = ((code - 97 - s + 260) % 26) + 97;
        result += String.fromCharCode(code);
      }
      return result;
    }

    function normalizeBase64(b64) {
      if (!b64 || typeof b64 !== 'string') return '';
      let s = b64.replace(/\s+/g, '');
      const m = s.match(/^data:.*;base64,(.*)$/i);
      if (m) s = m[1];
      s = s.replace(/-/g, '+').replace(/_/g, '/');
      const pad = s.length % 4;
      if (pad === 2) s += '=='; else if (pad === 3) s += '=';
      return s;
    }

    function base64ToBlob(base64, mime) {
      const cleaned = normalizeBase64(base64);
      const binary = atob(cleaned);
      const len = binary.length;
      const arr = new Uint8Array(len);
      for (let i = 0; i < len; i++) arr[i] = binary.charCodeAt(i);
      return new Blob([arr], { type: mime || 'application/octet-stream' });
    }

    function detectMimeFromBase64(b64) {
      try {
        const cleaned = normalizeBase64(b64).slice(0, 2000);
        if (!cleaned) return null;
        const bin = atob(cleaned.slice(0, 1000));
        if (bin.startsWith('\x89PNG')) return 'image/png';
        if (bin.charCodeAt(0) === 0xFF && bin.charCodeAt(1) === 0xD8) return 'image/jpeg';
        if (bin.startsWith('GIF87a') || bin.startsWith('GIF89a')) return 'image/gif';
        if (bin.indexOf('ftyp') !== -1) return 'video/mp4';
        if (bin.toLowerCase().indexOf('webm') !== -1) return 'video/webm';
        if (cleaned.startsWith('iVBOR')) return 'image/png';
        if (cleaned.startsWith('/9j/')) return 'image/jpeg';
        return null;
      } catch (e) { return null; }
    }

    function bytesToMB(n) {
      if (typeof n !== 'number' || isNaN(n)) return '–';
      return (n / (1024 * 1024)).toFixed(2) + ' MB';
    }

    const lockedOverlay = document.getElementById('lockedOverlay');
    function showLockedOverlay() { lockedOverlay.style.display = 'flex'; document.body.classList.add('blurred'); }
    function hideLockedOverlay() { lockedOverlay.style.display = 'none'; document.body.classList.remove('blurred'); }
    function isLoggedIn() { return localStorage.getItem('dekrip_logged_in') === 'true'; }

    async function fetchRelatedLinks(person) {
      const relatedSection = document.getElementById('relatedSection');
      const relatedList = document.getElementById('relatedList');
      relatedList.innerHTML = '';
      if (!person) { relatedSection.classList.add('hidden'); return; }
      const supabaseUrl = 'https://qzdvdfebkzlwkhvxwsju.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6ZHZkZmVia3psd2todnh3c2p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzcyMTA4OTksImV4cCI6MjA1Mjc4Njg5OX0.Z9XKmX49vu0kZwn6YMom8QeLNNdKQMXCIkxcIoHKQFs';
      const supabase = window.createClient(supabaseUrl, supabaseKey);
      const currentUrl = q('url');
      const currentShift = q('shift');
      try {
        const { data, error } = await supabase.from('links').select('id, person_name, name, category, url, shift_code').ilike('person_name', person);
        if (error) throw error;
        if (!data || data.length < 1) { relatedSection.classList.add('hidden'); return; }
        const grouped = {};
        data.forEach(item => {
          if (item.url === currentUrl && item.shift_code === currentShift) return;
          const cat = item.category || 'Belum Dikategorikan';
          if (!grouped[cat]) grouped[cat] = [];
          grouped[cat].push(item);
        });
        if (Object.keys(grouped).length === 0) { relatedSection.classList.add('hidden'); return; }
        Object.keys(grouped).sort().forEach(cat => {
          const groupDiv = document.createElement('div');
          groupDiv.className = 'mb-6';
          const h3 = document.createElement('h3');
          h3.className = 'font-semibold text-lg mb-3 text-gray-700';
          h3.textContent = cat;
          groupDiv.appendChild(h3);
          const ul = document.createElement('ul');
          ul.className = 'space-y-2';
          grouped[cat].forEach(item => {
            const li = document.createElement('li');
            li.className = 'p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition';
            li.textContent = `${item.person_name || 'Anonim'} - ${item.name || 'Tanpa Judul'}`;
            li.onclick = () => window.open(`dekripsi.html?url=${encodeURIComponent(item.url)}&shift=${encodeURIComponent(item.shift_code)}&person=${encodeURIComponent(item.person_name)}&name=${encodeURIComponent(item.name)}`, '_blank');
            ul.appendChild(li);
          });
          groupDiv.appendChild(ul);
          relatedList.appendChild(groupDiv);
        });
        relatedSection.classList.remove('hidden');
      } catch (err) {
        relatedList.innerHTML = '<p class="text-red-600">Gagal memuat konten terkait.</p>';
        relatedSection.classList.remove('hidden');
      }
    }

    async function generateQrCodeWithPadding(data, size = 300, padding = 20) {
      const tempCanvas = document.createElement('canvas');
      await QRCode.toCanvas(tempCanvas, data, { errorCorrectionLevel: 'H', margin: 0, width: size });
      const qrSize = tempCanvas.width;
      const totalSize = qrSize + padding * 2;
      const finalCanvas = document.createElement('canvas');
      finalCanvas.width = totalSize;
      finalCanvas.height = totalSize;
      const ctx = finalCanvas.getContext('2d');
      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, totalSize, totalSize);
      ctx.drawImage(tempCanvas, padding, padding, qrSize, qrSize);
      return finalCanvas;
    }

    async function loadAndDecrypt(url, shift, person, name) {
      const statusEl = document.getElementById('status');
      const previewEl = document.getElementById('preview');
      const metaEl = document.getElementById('meta');
      const fileSizeEl = document.getElementById('fileSize');
      const mimeEl = document.getElementById('detectedMime');
      const downloadOriginalBtn = document.getElementById('downloadOriginalBtn');
      const downloadDecryptedBtn = document.getElementById('downloadDecryptedBtn');

      let objectUrl = null;
      let currentBlob = null;
      let detectedMime = null;

      if (!url) {
        statusEl.innerHTML = '<span class="text-red-600">Parameter url tidak ditemukan.</span>';
        return;
      }

      statusEl.innerHTML = `<svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Memuat file...`;

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Gagal memuat file: ${res.status}`);
        const encryptedText = await res.text();

        statusEl.innerHTML = `<svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Mendekripsi...`;

        const decryptedContent = decryptCaesar(encryptedText, shift);
        const probableBase64 = decryptedContent.trim();
        const cleaned = normalizeBase64(probableBase64);
        const looksLikeBase64 = cleaned && /^[A-Za-z0-9+/=]+$/.test(cleaned);

        if (looksLikeBase64) {
          detectedMime = detectMimeFromBase64(cleaned) || '';
          currentBlob = base64ToBlob(cleaned, detectedMime);
          objectUrl = URL.createObjectURL(currentBlob);

          fileSizeEl.textContent = `Ukuran: ${bytesToMB(currentBlob.size)}`;
          mimeEl.textContent = `Tipe: ${detectedMime || 'Tidak terdeteksi'}`;
          metaEl.classList.remove('hidden');

          previewEl.innerHTML = `<div class="text-2xl font-bold mb-6 text-gray-800">${person || 'Anonim'} – ${name || 'Tanpa Judul'}</div>`;

          if (detectedMime.startsWith('image/')) {
            const img = document.createElement('img');
            img.src = objectUrl;
            img.alt = name;
            img.className = 'media-wrap';
            previewEl.appendChild(img);
          } else if (detectedMime.startsWith('video/')) {
            const video = document.createElement('video');
            video.src = objectUrl;
            video.controls = true;
            video.playsInline = true;
            video.loop = true;
            video.className = 'media-wrap';
            previewEl.appendChild(video);
          } else {
            const pre = document.createElement('pre');
            pre.className = 'p-6 bg-gray-100 rounded-lg text-sm overflow-x-auto';
            pre.textContent = cleaned.slice(0,2000) + (cleaned.length > 2000 ? '\n\n... (terpotong)' : '');
            previewEl.appendChild(pre);
          }
        } else {
          const textBlob = new Blob([decryptedContent], { type: 'text/plain' });
          fileSizeEl.textContent = `Ukuran: ${bytesToMB(textBlob.size)}`;
          mimeEl.textContent = 'Tipe: text/plain';
          metaEl.classList.remove('hidden');
          previewEl.innerHTML = `<div class="text-2xl font-bold mb-6 text-gray-800">${person || 'Anonim'} – ${name || 'Tanpa Judul'}</div>`;
          const pre = document.createElement('pre');
          pre.className = 'p-6 bg-gray-100 rounded-lg whitespace-pre-wrap';
          pre.textContent = decryptedContent;
          previewEl.appendChild(pre);
        }

        statusEl.innerHTML = '<span class="text-green-600 font-semibold">✔ Selesai</span>';

        const blobPB = new Blob([encryptedText], { type: 'application/octet-stream' });
        const urlPB = URL.createObjectURL(blobPB);
        downloadOriginalBtn.href = urlPB;
        downloadOriginalBtn.download = 'file.pb';
        downloadOriginalBtn.classList.remove('hidden');

        const blobDecrypted = currentBlob || new Blob([decryptedContent], { type: 'application/octet-stream' });
        const urlDecrypted = URL.createObjectURL(blobDecrypted);
        downloadDecryptedBtn.href = urlDecrypted;
        downloadDecryptedBtn.download = name || 'decrypted_file';
        downloadDecryptedBtn.classList.remove('hidden');

        if (url && shift !== '') {
          const qrData = `${url} || ${shift}`;
          const safePerson = (person || 'Anonim').replace(/[^a-zA-Z0-9 -]/g, '');
          const safeName = (name || 'Konten').replace(/[^a-zA-Z0-9 -]/g, '');
          const qrFilename = `${safePerson} - ${safeName} - QR.png`.replace(/  +/g, ' ').trim();

          const paddedCanvas = await generateQrCodeWithPadding(qrData, 320, 30);
          const qrCanvas = document.getElementById('qrCanvas');
          qrCanvas.width = paddedCanvas.width;
          qrCanvas.height = paddedCanvas.height;
          qrCanvas.getContext('2d').drawImage(paddedCanvas, 0, 0);

          document.getElementById('downloadQrBtn').onclick = () => {
            const a = document.createElement('a');
            a.href = paddedCanvas.toDataURL('image/png');
            a.download = qrFilename;
            a.click();
          };

          document.getElementById('qrSection').classList.remove('hidden');
        }

        window.addEventListener('beforeunload', () => {
          if (objectUrl) URL.revokeObjectURL(objectUrl);
          URL.revokeObjectURL(urlPB);
          URL.revokeObjectURL(urlDecrypted);
        });

      } catch (err) {
        statusEl.innerHTML = `<span class="text-red-600">Gagal: ${err.message}</span>`;
      }
    }

    async function main() {
      const url = q('url');
      const shift = q('shift') || '0';
      const person = q('person') || '';
      const name = q('name') || '';
      await loadAndDecrypt(url, shift, person, name);
      await fetchRelatedLinks(person);
    }

    document.getElementById('toggleRelated')?.addEventListener('click', () => {
      const list = document.getElementById('relatedList');
      const chevron = document.getElementById('chevron');
      list.classList.toggle('hidden');
      chevron.classList.toggle('rotate-180');
    });

    if (isLoggedIn()) {
      hideLockedOverlay();
      main();
    } else {
      showLockedOverlay();
    }

    window.addEventListener('focus', () => {
      if (isLoggedIn()) {
        hideLockedOverlay();
        main();
      }
    });
  </script>
</body>
</html>
