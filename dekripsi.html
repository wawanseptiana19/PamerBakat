<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hasil Dekripsi & Preview</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- Tambahkan Supabase client untuk fetch data terkait -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.2/+esm';
    window.createClient = createClient; // Buat global untuk akses di script utama
  </script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6; /* Lighter background */
      padding: 0;
      margin: 0;
    }
    .main-container {
      width: 100%;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1.5rem; /* Padding lebih besar */
      box-sizing: border-box;
    }
    .content-card {
      background-color: #ffffff;
      width: 100%;
      max-width: 900px; /* Lebar maksimum yang lebih luas */
      padding: 2rem;
      border-radius: 1.5rem; /* Sudut lebih membulat */
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
    }
    #lockedOverlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.85);
      z-index: 99999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      color: white;
    }
    #lockedBox {
      background: #1e293b; /* Darker blue-gray background */
      border-radius: 1.5rem;
      padding: 30px;
      width: 100%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    body.blurred .main-container {
      filter: blur(6px) saturate(0.9);
      transition: filter 0.25s ease;
      pointer-events: none;
      user-select: none;
    }
    .download-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.85rem 2rem; /* Padding lebih besar */
      border-radius: 0.75rem; /* Sudut lebih membulat */
      font-weight: 600;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    .download-btn.secondary {
      background-color: #e5e7eb; /* Gray */
      color: #1f2937;
    }
    .download-btn.secondary:hover {
      background-color: #d1d5db;
    }
    .download-btn.primary {
      background-color: #4f46e5; /* Indigo */
      color: #ffffff;
      box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
    }
    .download-btn.primary:hover {
      background-color: #4338ca;
      box-shadow: 0 6px 20px rgba(79, 70, 229, 0.5);
      transform: translateY(-1px);
    }
    .media-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      width: 100%;
    }
    .frame-btn {
      /* Menggunakan style primary button */
      @apply download-btn primary;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
    }
    .frames-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
      width: 100%;
    }
    .frame-img {
      width: 100%;
      height: auto;
      border-radius: 0.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: transform 0.2s;
    }
    .frame-img:hover {
      transform: scale(1.02);
    }
    /* Modal Styles */
    #imageModal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.95);
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-content {
      max-width: 90%;
      max-height: 90vh;
      border-radius: 12px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
    }
    .close-btn {
      position: fixed; /* Ubah ke fixed agar tetap di pojok */
      top: 25px;
      right: 35px;
      color: #f1f1f1;
      font-size: 48px;
      font-weight: 300;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.2s;
    }
    .close-btn:hover,
    .close-btn:focus {
      opacity: 1;
    }
    .modal-download-btn {
      position: fixed; /* Ubah ke fixed */
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #10B981;
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
      transition: background-color 0.2s;
    }
    .modal-download-btn:hover {
      background-color: #059669;
    }
    /* Style untuk list terkait baru */
    #relatedSection {
      margin-top: 2rem;
      padding: 1.5rem;
      background-color: #f9fafb; /* Light subtle background */
      border-radius: 1rem;
      border: 1px solid #e5e7eb;
    }
    .category-group {
      margin-bottom: 1.5rem;
    }
    .category-heading {
      font-weight: 700;
      margin-bottom: 0.75rem;
      color: #1f2937;
      font-size: 1.25rem;
    }
    .related-sublist {
      list-style-type: none;
      padding: 0;
      display: grid;
      gap: 0.5rem;
    }
    .related-sublist li {
      padding: 1rem;
      background-color: #ffffff;
      border-radius: 0.75rem;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border: 1px solid #e5e7eb;
      font-size: 0.95rem;
    }
    .related-sublist li:hover {
      background-color: #f3f4f6;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .size-range-input {
        @apply w-48 h-2 bg-indigo-200 rounded-lg appearance-none cursor-pointer;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="main-container">
    <div class="content-card">
      <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Hasil Dekripsi & Preview</h1>
      <p class="text-md text-gray-500 mb-8">Pratinjau konten Anda yang terdekripsi dan tautan terkait.</p>

      <!-- Status Bar (Updated Design) -->
      <div id="status" class="mb-8 text-base font-semibold text-blue-800 bg-blue-50 p-4 rounded-xl flex items-center gap-3 border border-blue-200">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-blue-600 animate-spin" id="status-icon">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
        </svg>
        Memuat...
      </div>

      <!-- Preview Section -->
      <div id="preview" class="mb-8 p-4 bg-gray-50 rounded-xl flex justify-center">
        <!-- Konten dekripsi akan dimuat di sini -->
      </div>
      
      <!-- Download Buttons -->
      <div class="flex justify-center gap-4 mt-6">
        <a id="downloadOriginalBtn" class="download-btn secondary hidden">
          Unduh File Asli (.pb)
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 ml-2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
          </svg>
        </a>
        <a id="downloadDecryptedBtn" class="download-btn primary hidden">
          Unduh Dekripsi
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 ml-2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
          </svg>
        </a>
      </div>

      <!-- Metadata -->
      <div id="meta" class="mt-8 pt-4 border-t border-gray-100 flex items-center justify-center flex-wrap gap-6 text-sm text-gray-600 hidden">
        <div class="flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-indigo-500">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 7.5l-9-5.25L3 7.5m18 0l-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9" />
          </svg>
          <span id="fileSize" class="font-semibold">Ukuran: -</span>
        </div>
        <div class="flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-green-500">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25m-9-9h1.5a3.375 3.375 0 0 1 3.375 3.375v1.5a1.125 1.125 0 0 0-1.125 1.125h-1.5a3.375 3.375 0 0 1-3.375-3.375V2.25Z" />
          </svg>
          <span id="detectedMime">Tipe: -</span>
        </div>
      </div>

      <!-- Controls for Media -->
      <div class="mt-8 border-t border-gray-100 pt-6">
        <div id="videoControls" class="mb-6 hidden">
          <label class="block text-lg font-semibold text-gray-700 mb-3">Atur Ukuran Video</label>
          <div class="flex flex-col sm:flex-row items-center gap-4 p-4 bg-gray-50 rounded-xl">
            <input id="sizeRangeVideo" type="range" min="20" max="150" value="100" class="size-range-input">
            <div id="sizeLabelVideo" class="text-base text-indigo-700 font-bold w-16 text-center">100%</div>
          </div>
          <div class="flex justify-center mt-4">
            <button id="showFramesBtn" class="frame-btn hidden">
              Tampilkan Semua Frame
            </button>
          </div>
        </div>

        <div id="imageControls" class="mb-6 hidden">
          <label class="block text-lg font-semibold text-gray-700 mb-3">Atur Ukuran Gambar</label>
          <div class="flex flex-col sm:flex-row items-center gap-4 p-4 bg-gray-50 rounded-xl">
            <input id="sizeRangeImage" type="range" min="10" max="200" value="100" class="size-range-input">
            <div id="sizeLabelImage" class="text-base text-indigo-700 font-bold w-16 text-center">100%</div>
          </div>
        </div>
      </div>

      <!-- Frames Preview -->
      <div id="framesPreview" class="mb-8 hidden mt-8 pt-4 border-t border-gray-100">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Semua Frame Video</h2>
        <div class="frames-container"></div>
      </div>

      <!-- Related Content Section (Redesigned) -->
      <div id="relatedSection" class="hidden mt-8">
        <h2 class="text-3xl font-bold text-gray-800 mb-4 border-t pt-6 border-gray-100">Konten Terkait</h2>
        <div id="relatedList" class="text-sm text-gray-700"></div>
      </div>

    </div>

    <footer class="text-sm text-gray-500 mt-8 text-center max-w-lg p-4">
      <p>Parameter yang diterima: <code>?url=&lt;URL&gt;&amp;shift=&lt;angka&gt;&amp;person=&lt;nama&gt;&amp;name=&lt;judul&gt;</code></p>
      <p class="mt-2">Contoh: <code>dekripsi.html?url=https://example.com/file.txt&amp;shift=3</code></p>
    </footer>
  </div>

  <!-- Locked Overlay (Updated Design) -->
  <div id="lockedOverlay" role="dialog" aria-modal="true">
    <div id="lockedBox" role="document">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mx-auto text-indigo-400 mb-4">
        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-6 3h18a2.25 2.25 0 0 1 2.25 2.25v6.75a2.25 2.25 0 0 1-2.25 2.25H2.25A2.25 2.25 0 0 1 0 19.5v-6.75A2.25 2.25 0 0 1 2.25 10.5Z" />
      </svg>
      <h2 class="text-2xl font-bold mb-2">Akses Terkunci</h2>
      <p class="text-indigo-200">Anda harus login terlebih dahulu untuk melihat konten yang terdekripsi ini.</p>
    </div>
  </div>

  <!-- Image Modal (Updated Styles) -->
  <div id="imageModal">
    <span class="close-btn">&times;</span>
    <img class="modal-content" id="modalImage">
    <a id="modalDownloadBtn" class="modal-download-btn" download>Download Gambar</a>
  </div>

  <script>
    // Utility functions (grouped and cleaned)
    function q(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name) || '';
    }

    function decryptCaesar(text, shift) {
      if (typeof text !== 'string') return text;
      const s = Number(shift);
      if (isNaN(s)) return text;
      let result = '';
      for (let i = 0; i < text.length; i++) {
        let code = text.charCodeAt(i);
        if (code >= 65 && code <= 90) {
          code = ((code - 65 - s + 260) % 26) + 65;
        } else if (code >= 97 && code <= 122) {
          code = ((code - 97 - s + 260) % 26) + 97;
        }
        result += String.fromCharCode(code);
      }
      return result;
    }

    function normalizeBase64(b64) {
      if (!b64 || typeof b64 !== 'string') return '';
      let s = b64.replace(/\s+/g, '');
      const m = s.match(/^data:.*;base64,(.*)$/i);
      if (m) s = m[1];
      s = s.replace(/-/g, '+').replace(/_/g, '/');
      const pad = s.length % 4;
      if (pad === 2) s += '=='; else if (pad === 3) s += '=';
      return s;
    }

    function base64ToBlob(base64, mime) {
      const cleaned = normalizeBase64(base64);
      const binary = atob(cleaned);
      const len = binary.length;
      const arr = new Uint8Array(len);
      for (let i = 0; i < len; i++) arr[i] = binary.charCodeAt(i);
      return new Blob([arr], { type: mime || 'application/octet-stream' });
    }

    function detectMimeFromBase64(b64) {
      try {
        const cleaned = normalizeBase64(b64).slice(0, 2000);
        if (!cleaned) return null;
        const bin = atob(cleaned.slice(0, 1000));
        if (bin.startsWith('\x89PNG')) return 'image/png';
        if (bin.charCodeAt(0) === 0xFF && bin.charCodeAt(1) === 0xD8) return 'image/jpeg';
        if (bin.startsWith('GIF87a') || bin.startsWith('GIF89a')) return 'image/gif';
        if (bin.indexOf('ftyp') !== -1) return 'video/mp4';
        if (bin.toLowerCase().indexOf('webm') !== -1) return 'video/webm';
        if (cleaned.startsWith('iVBOR')) return 'image/png';
        if (cleaned.startsWith('/9j/')) return 'image/jpeg';
        return null;
      } catch (e) {
        return null;
      }
    }

    function bytesToMB(n) {
      if (typeof n !== 'number' || isNaN(n)) return '-';
      return (n / (1024 * 1024)).toFixed(2) + ' MB';
    }

    function createLabel(text) {
      const h = document.createElement('div');
      h.className = 'text-lg text-gray-700 font-semibold mb-3 w-full';
      h.textContent = text || '';
      return h;
    }

    // Access control functions
    const lockedOverlay = document.getElementById('lockedOverlay');

    function showLockedOverlay() {
      lockedOverlay.style.display = 'flex';
      document.body.classList.add('blurred');
    }

    function hideLockedOverlay() {
      lockedOverlay.style.display = 'none';
      document.body.classList.remove('blurred');
    }

    function isLoggedIn() {
      return localStorage.getItem('dekrip_logged_in') === 'true';
    }

    // Helper untuk update status bar
    function updateStatus(message, type = 'loading') {
      const statusEl = document.getElementById('status');
      const statusIcon = document.getElementById('status-icon');

      let colorClasses, iconSvg;

      if (type === 'loading') {
        colorClasses = 'text-blue-800 bg-blue-50 border-blue-200';
        iconSvg = `<path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />`;
        statusIcon.classList.add('animate-spin');
      } else if (type === 'success') {
        colorClasses = 'text-green-800 bg-green-50 border-green-200';
        iconSvg = `<path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />`;
        statusIcon.classList.remove('animate-spin');
      } else if (type === 'error') {
        colorClasses = 'text-red-800 bg-red-50 border-red-200';
        iconSvg = `<path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.731 0 2.813-1.874 1.948-3.374L13.949 3.374c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />`;
        statusIcon.classList.remove('animate-spin');
      }

      statusEl.className = `mb-8 text-base font-semibold p-4 rounded-xl flex items-center gap-3 border ${colorClasses}`;
      statusIcon.innerHTML = iconSvg;
      statusEl.querySelector('span')?.remove();
      const textSpan = document.createElement('span');
      textSpan.textContent = message;
      statusEl.appendChild(textSpan);
    }

    // Fungsi baru untuk fetch dan tampilkan list terkait dari Supabase
    async function fetchRelatedLinks(person) {
      const relatedSection = document.getElementById('relatedSection');
      const relatedList = document.getElementById('relatedList');
      relatedList.innerHTML = ''; // Kosongkan list

      if (!person) {
        relatedSection.classList.add('hidden');
        return;
      }

      // Konfigurasi Supabase (sama seperti di index.html)
      const supabaseUrl = 'https://qzdvdfebkzlwkhvxwsju.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6ZHZkZmVia3psd2todnh3c2p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzcyMTA4OTksImV4cCI6MjA1Mjc4Njg5OX0.Z9XKmX49vu0kZwn6YMom8QeLNNdKQMXCIkxcIoHKQFs';
      const supabase = window.createClient(supabaseUrl, supabaseKey);

      try {
        const { data, error } = await supabase
          .from('links')
          .select('id, person_name, name, category, url, shift_code')
          .ilike('person_name', `%${person}%`); // Case-insensitive match

        if (error) throw error;
        // Filter out the current item if it exists and check if there are others
        const currentUrl = q('url');
        const currentShift = q('shift');
        const filteredData = data.filter(item => !(item.url === currentUrl && String(item.shift_code) === currentShift));

        if (!filteredData || filteredData.length === 0) {
          relatedSection.classList.add('hidden');
          return;
        }

        // Group data by category
        const groupedByCategory = {};
        filteredData.forEach(item => {
          const cat = item.category || 'Belum Dikategorikan';
          if (!groupedByCategory[cat]) {
            groupedByCategory[cat] = [];
          }
          groupedByCategory[cat].push(item);
        });

        // Render grouped list
        Object.keys(groupedByCategory).sort().forEach(category => {
          const groupDiv = document.createElement('div');
          groupDiv.className = 'category-group';

          const heading = document.createElement('h3');
          heading.className = 'category-heading';
          heading.textContent = category;
          groupDiv.appendChild(heading);

          const sublist = document.createElement('ul');
          sublist.className = 'related-sublist';

          groupedByCategory[category].forEach(item => {
            const li = document.createElement('li');
            li.innerHTML = `<div class="font-medium text-gray-900">${item.name || 'Tanpa Judul'}</div>
                            <div class="text-xs text-gray-500 mt-0.5">Oleh: ${item.person_name || 'Anonim'}</div>`;
            li.dataset.url = item.url;
            li.dataset.shift = item.shift_code;
            li.dataset.person = item.person_name;
            li.dataset.name = item.name;
            li.addEventListener('click', () => {
              // Buka tab baru untuk dekripsi
              const targetUrl = `dekripsi.html?url=${encodeURIComponent(item.url)}&shift=${encodeURIComponent(item.shift_code)}&person=${encodeURIComponent(item.person_name)}&name=${encodeURIComponent(item.name)}`;
              window.open(targetUrl, '_blank');
            });
            sublist.appendChild(li);
          });

          groupDiv.appendChild(sublist);
          relatedList.appendChild(groupDiv);
        });

        relatedSection.classList.remove('hidden');
      } catch (err) {
        console.error('Gagal fetch data terkait:', err);
        updateStatus('Gagal memuat konten terkait.', 'error');
        relatedSection.classList.remove('hidden');
      }
    }

    // Fungsi untuk load dan dekripsi konten (hanya untuk item utama, karena terkait dibuka di tab baru)
    async function loadAndDecrypt(url, shift, person, name) {
      const previewEl = document.getElementById('preview');
      const metaEl = document.getElementById('meta');
      const fileSizeEl = document.getElementById('fileSize');
      const mimeEl = document.getElementById('detectedMime');
      const downloadOriginalBtn = document.getElementById('downloadOriginalBtn');
      const downloadDecryptedBtn = document.getElementById('downloadDecryptedBtn');
      const videoControls = document.getElementById('videoControls');
      const sizeRangeVideo = document.getElementById('sizeRangeVideo');
      const sizeLabelVideo = document.getElementById('sizeLabelVideo');
      const imageControls = document.getElementById('imageControls');
      const sizeRangeImage = document.getElementById('sizeRangeImage');
      const sizeLabelImage = document.getElementById('sizeLabelImage');
      const showFramesBtn = document.getElementById('showFramesBtn');
      const framesPreview = document.getElementById('framesPreview');
      const framesContainer = framesPreview.querySelector('.frames-container');

      let objectUrl = null;
      let currentBlob = null;
      let detectedMime = null;
      let videoEl = null;
      let imageEl = null;
      let decryptedContent = '';

      // Load saved settings
      const KEY_IMG = 'dekrip_image_size_pct';
      const KEY_VID = 'dekrip_video_size_pct';
      const savedImg = localStorage.getItem(KEY_IMG);
      const savedVid = localStorage.getItem(KEY_VID);
      if (savedImg) {
        sizeRangeImage.value = savedImg;
        sizeLabelImage.textContent = `${savedImg}%`;
      }
      if (savedVid) {
        sizeRangeVideo.value = savedVid;
        sizeLabelVideo.textContent = `${savedVid}%`;
      }

      if (!url) {
        updateStatus('Parameter url tidak ditemukan. Pastikan ?url= di query string.', 'error');
        return;
      }

      updateStatus('Memuat file...');

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Gagal memuat file: ${res.status}`);
        const encryptedText = await res.text();

        updateStatus('Mendekripsi...');

        decryptedContent = decryptCaesar(encryptedText, shift);
        const probableBase64 = decryptedContent.trim();
        const cleaned = normalizeBase64(probableBase64);
        const looksLikeBase64 = cleaned && /^[A-Za-z0-9+/=]+$/.test(cleaned);

        // --- Setup Metadata and Download Links (Always done) ---
        const blobPB = new Blob([encryptedText], { type: 'application/octet-stream' });
        const tmpUrlPB = URL.createObjectURL(blobPB);
        downloadOriginalBtn.href = tmpUrlPB;
        downloadOriginalBtn.download = (name ? name.replace(/\s/g, '_') : 'file') + '.pb';
        downloadOriginalBtn.classList.remove('hidden');

        let blobDecrypted;

        if (looksLikeBase64) {
          detectedMime = detectMimeFromBase64(cleaned) || 'application/octet-stream';
          currentBlob = base64ToBlob(cleaned, detectedMime);
          objectUrl = URL.createObjectURL(currentBlob);
          blobDecrypted = currentBlob;

          const bytesToShow = currentBlob.size;
          fileSizeEl.textContent = `Ukuran: ${bytesToMB(bytesToShow)}`;
          mimeEl.textContent = `Tipe: ${detectedMime}`;
          metaEl.classList.remove('hidden');

          if (detectedMime.startsWith('video/')) {
            previewEl.innerHTML = '';
            videoEl = document.createElement('video');
            videoEl.controls = true;
            videoEl.playsInline = true;
            videoEl.className = 'rounded-xl shadow-lg w-full max-w-2xl';
            const initPct = Number(sizeRangeVideo.value || 100);
            videoEl.style.width = `${initPct}%`;
            videoEl.src = objectUrl;
            videoEl.loop = true;

            const wrap = document.createElement('div');
            wrap.className = 'media-wrap w-full';
            wrap.appendChild(createLabel(`${person} - ${name}`));
            wrap.appendChild(videoEl);
            previewEl.classList.remove('justify-center');
            previewEl.appendChild(wrap);

            videoControls.classList.remove('hidden');
            showFramesBtn.classList.remove('hidden');
            imageControls.classList.add('hidden');

            sizeRangeVideo.oninput = () => {
              const val = Number(sizeRangeVideo.value);
              sizeLabelVideo.textContent = `${val}%`;
              videoEl.style.width = `${val}%`;
              localStorage.setItem(KEY_VID, val);
            };

            // Frame extraction logic
            showFramesBtn.onclick = async () => {
              if (framesContainer.innerHTML) return; // Already extracted
              framesPreview.classList.remove('hidden');
              updateStatus('Mengekstrak frame... Ini mungkin memakan waktu.', 'loading');
              videoEl.pause();

              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              canvas.width = videoEl.videoWidth;
              canvas.height = videoEl.videoHeight;
              
              const duration = videoEl.duration;
              const fps = 5; // Mengurangi FPS untuk performa yang lebih baik
              const frameCount = Math.min(Math.floor(duration * fps), 30); // Max 30 frames
              const frameInterval = 1 / fps;

              for (let i = 0; i < frameCount; i++) {
                videoEl.currentTime = i * frameInterval;
                await new Promise(resolve => videoEl.addEventListener('seeked', resolve, { once: true }));
                ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
                const img = document.createElement('img');
                img.src = canvas.toDataURL('image/jpeg');
                img.className = 'frame-img';
                img.alt = `Frame ${i + 1}`;
                framesContainer.appendChild(img);
              }

              updateStatus('Ekstraksi frame selesai.', 'success');

              // Add click event to each frame image for modal
              const frameImages = framesContainer.querySelectorAll('.frame-img');
              frameImages.forEach((img, index) => {
                img.addEventListener('click', () => {
                  modal.style.display = 'flex';
                  modalImage.src = img.src;
                  modalDownloadBtn.href = img.src;
                  modalDownloadBtn.download = (name ? name.replace(/\s/g, '_') : 'frame') + `_${index + 1}.jpg`;
                });
              });
            };

          } else if (detectedMime.startsWith('image/')) {
            previewEl.innerHTML = '';
            imageEl = document.createElement('img');
            imageEl.src = objectUrl;
            imageEl.alt = `${person} - ${name}`;
            imageEl.className = 'rounded-xl shadow-lg w-full max-w-lg cursor-pointer'; // Tambah cursor-pointer
            const initImgPct = Number(sizeRangeImage.value || 100);
            imageEl.style.width = `${initImgPct}%`;
            imageEl.onclick = () => {
              modal.style.display = 'flex';
              modalImage.src = imageEl.src;
              modalDownloadBtn.href = imageEl.src;
              modalDownloadBtn.download = (name ? name.replace(/\s/g, '_') : 'image') + '.jpg';
            };

            const wrap = document.createElement('div');
            wrap.className = 'media-wrap w-full';
            wrap.appendChild(createLabel(`${person} - ${name}`));
            wrap.appendChild(imageEl);
            previewEl.classList.remove('justify-center');
            previewEl.appendChild(wrap);

            imageControls.classList.remove('hidden');
            videoControls.classList.add('hidden');

            sizeRangeImage.oninput = () => {
              const val = Number(sizeRangeImage.value);
              sizeLabelImage.textContent = `${val}%`;
              imageEl.style.width = `${val}%`;
              localStorage.setItem(KEY_IMG, val);
            };

          } else {
            // Base64 non-media
            previewEl.innerHTML = '';
            previewEl.appendChild(createLabel(`${person} - ${name}`));
            const pre = document.createElement('pre');
            pre.className = 'mt-3 p-4 bg-gray-100 rounded-lg text-sm max-h-64 overflow-auto border border-gray-200 whitespace-pre-wrap w-full';
            pre.textContent = `[Preview base64 (dipotong)]\n${cleaned.slice(0, 1500)}${cleaned.length > 1500 ? '\n\n... (terpotong) ...' : ''}`;
            previewEl.appendChild(pre);
            previewEl.classList.remove('justify-center');
            videoControls.classList.add('hidden');
            imageControls.classList.add('hidden');
          }
        } else {
          // Plain Text
          blobDecrypted = new Blob([decryptedContent], { type: 'text/plain' });
          
          fileSizeEl.textContent = `Ukuran: ${bytesToMB(blobDecrypted.size)}`;
          mimeEl.textContent = 'Tipe: text/plain';
          metaEl.classList.remove('hidden');
          previewEl.innerHTML = '';
          previewEl.appendChild(createLabel(`${person} - ${name}`));
          const pre = document.createElement('pre');
          pre.className = 'mt-3 p-4 bg-gray-100 rounded-lg text-sm whitespace-pre-wrap border border-gray-200 w-full';
          pre.textContent = decryptedContent;
          previewEl.appendChild(pre);
          previewEl.classList.remove('justify-center');
          videoControls.classList.add('hidden');
          imageControls.classList.add('hidden');
        }

        const tmpUrlDecrypted = URL.createObjectURL(blobDecrypted);
        downloadDecryptedBtn.href = tmpUrlDecrypted;
        // Tentukan nama file yang didownload
        let downloadName = name || 'decrypted_file';
        if (detectedMime) {
          const ext = detectedMime.split('/')[1] || 'txt';
          downloadDecryptedBtn.download = downloadName.replace(/\s/g, '_') + '.' + (ext === 'jpeg' ? 'jpg' : ext);
        } else {
          downloadDecryptedBtn.download = downloadName.replace(/\s/g, '_') + '.txt';
        }
        
        downloadDecryptedBtn.classList.remove('hidden');

        updateStatus('Selesai.', 'success');

        window.addEventListener('beforeunload', () => {
          URL.revokeObjectURL(tmpUrlPB);
          URL.revokeObjectURL(tmpUrlDecrypted);
          if (objectUrl) URL.revokeObjectURL(objectUrl);
        });

      } catch (err) {
        console.error(err);
        updateStatus(`Gagal memuat/mendekripsi: ${err.message}`, 'error');
      }

      window.addEventListener('beforeunload', () => {
        if (objectUrl) URL.revokeObjectURL(objectUrl);
      });
    }

    // Main function
    async function ensureAndRunMain() {
      if (ensureAndRunMain._started) return;
      ensureAndRunMain._started = true;

      const url = q('url');
      const shift = q('shift') || '0';
      const person = q('person') || '';
      const name = q('name') || '';

      // Jalankan dekripsi utama
      await loadAndDecrypt(url, shift, person, name);

      // Fetch list terkait setelah dekripsi utama selesai
      await fetchRelatedLinks(person);
    }

    // Modal functionality
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const closeBtn = document.querySelector('.close-btn');
    const modalDownloadBtn = document.getElementById('modalDownloadBtn');

    closeBtn.addEventListener('click', () => {
      modal.style.display = 'none';
    });

    modal.addEventListener('click', (event) => {
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    });

    // Initialization
    (function initAccessCheck() {
      if (isLoggedIn()) {
        hideLockedOverlay();
        ensureAndRunMain();
      } else {
        showLockedOverlay();
      }

      window.addEventListener('focus', () => {
        if (isLoggedIn()) {
          hideLockedOverlay();
          ensureAndRunMain();
        }
      });
    })();
  </script>
</body>
</html>
